<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt sân - Sân Bóng Bình Minh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .time-slot {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .time-slot:hover {
            transform: translateY(-2px);
            background-color: rgba(25, 135, 84, 0.1);
        }
        
        .time-slot.selected {
            background-color: rgba(25, 135, 84, 0.2);
            color: #000;
            border-color: #198754;
        }
        
        .time-slot.unavailable {
            background-color: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        /* CSS cho khung giờ bị xung đột với sân gộp */
        .time-slot.conflict {
            background-color: #fff3cd;
            color: #856404;
            cursor: not-allowed;
            border-color: #ffeeba;
        }
        
        .breadcrumb-section {
            background-color: #f8f9fa;
            padding: 15px 0;
        }
        
        .booking-overview {
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            padding: 1rem;
        }
        
        /* Thêm CSS cho bảng khung giờ */
        .table-bordered {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        
        .table td.time-slot {
            padding: 15px 10px;
            vertical-align: middle;
        }
        
        /* CSS cho khung giờ đã có người đặt */
        .time-slot.booked {
            background-color: #ffebee;
            color: #b71c1c;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        /* Màu sắc cho các buổi trong ngày */
        .bg-light-yellow {
            background-color: #FFF9C4 !important;
            color: #F57F17;
        }
        
        .bg-light-blue {
            background-color: #E3F2FD !important;
            color: #1565C0;
        }
        
        .bg-light-purple {
            background-color: #F3E5F5 !important;
            color: #6A1B9A;
        }
        
        /* Màu nền nhẹ cho các ô thời gian theo buổi */
        .morning-slot {
            background-color: rgba(255, 249, 196, 0.2);
        }
        
        .afternoon-slot {
            background-color: rgba(227, 242, 253, 0.2);
        }
        
        .evening-slot {
            background-color: rgba(243, 229, 245, 0.2);
        }
        
        /* Giữ màu nền khi selected */
        .morning-slot.selected {
            background-color: rgba(245, 127, 23, 0.2);
            border-color: #F57F17;
        }
        
        .afternoon-slot.selected {
            background-color: rgba(21, 101, 192, 0.2);
            border-color: #1565C0;
        }
        
        .evening-slot.selected {
            background-color: rgba(106, 27, 154, 0.2);
            border-color: #6A1B9A;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-futbol me-2"></i>Sân Bóng Bình Minh
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i>Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-calendar-check me-1"></i>Đặt sân</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my-bookings.html"><i class="fas fa-list me-1"></i>Sân đã đặt</a>
                    </li>
                </ul>
                <div class="d-flex gap-2">
                    <div id="user-menu">
                        <div class="dropdown">
                            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="user-name">Tài khoản</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user me-2"></i>Thông tin cá nhân</a></li>
                                <li><a class="dropdown-item" href="my-bookings.html"><i class="fas fa-list me-2"></i>Sân đã đặt</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="breadcrumb-section">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="javascript:history.back()">Danh sách sân</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Đặt sân</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Booking Section -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-12 mb-4">
                    <h2 id="pitch-name">Đặt sân bóng</h2>
                    <p id="pitch-description" class="text-muted">Đang tải thông tin sân...</p>
                </div>
            </div>

            <div class="row">
                <!-- Booking Form -->
                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Chọn ngày và giờ đặt sân</h5>
                            
                            <!-- Thông báo về sân gộp nếu cần -->
                            <div id="combined-pitch-notice" class="alert alert-warning d-none mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Lưu ý về sân gộp:</strong> Sân này có thể là sân gộp hoặc là một phần của sân gộp khác.
                                Khi đặt sân này, các sân liên quan sẽ không thể đặt trong cùng khung giờ.
                            </div>
                            
                            <!-- Date Selection -->
                            <div class="mb-4">
                                <label class="form-label"><i class="fas fa-calendar me-2"></i>Ngày đặt sân</label>
                                <input type="text" class="form-control" id="booking-date" placeholder="Chọn ngày">
                            </div>
                            
                            <!-- Time Slots -->
                            <div class="mb-4">
                                <label class="form-label"><i class="fas fa-clock me-2"></i>Chọn giờ</label>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-center bg-light-yellow" colspan="8">Khung giờ đặt sân</th>
                                            </tr>
                                        </thead>
                                        <tbody id="time-slots-table">
                                            <tr>
                                                <td class="text-center bg-light-yellow fw-bold" colspan="8">Buổi sáng</td>
                                            </tr>
                                            <tr id="morning-slots">
                                                <!-- Khung giờ buổi sáng sẽ được tạo động bằng JavaScript -->
                                                <td colspan="8" class="text-center py-3">Đang tải khung giờ...</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center bg-light-blue fw-bold" colspan="8">Buổi chiều</td>
                                            </tr>
                                            <tr id="afternoon-slots">
                                                <!-- Khung giờ buổi chiều sẽ được tạo động bằng JavaScript -->
                                                <td colspan="8" class="text-center py-3">Đang tải khung giờ...</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center bg-light-purple fw-bold" colspan="8">Buổi tối</td>
                                            </tr>
                                            <tr id="evening-slots">
                                                <!-- Khung giờ buổi tối sẽ được tạo động bằng JavaScript -->
                                                <td colspan="8" class="text-center py-3">Đang tải khung giờ...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div id="no-time-slots" class="alert alert-info mt-3" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Không có khung giờ trống cho ngày này. Vui lòng chọn ngày khác.
                                </div>
                            </div>
                            
                            <!-- Additional Information -->
                            <div class="mb-4">
                                <label class="form-label"><i class="fas fa-info-circle me-2"></i>Ghi chú</label>
                                <textarea class="form-control" id="booking-note" rows="3" placeholder="Nhập ghi chú nếu cần..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Booking Summary -->
                <div class="col-md-4">
                    <div class="card shadow-sm mb-4 position-sticky" style="top: 20px;">
                        <div class="card-body">
                            <h5 class="card-title">Thông tin đặt sân</h5>
                            
                            <div class="booking-overview mb-3">
                                <div class="mb-3">
                                    <span class="fw-bold">Sân:</span>
                                    <span id="summary-pitch-name">...</span>
                                </div>
                                <div class="mb-3">
                                    <span class="fw-bold">Ngày:</span>
                                    <span id="summary-date">Chưa chọn</span>
                                </div>
                                <div class="mb-3">
                                    <span class="fw-bold">Giờ:</span>
                                    <span id="summary-time">Chưa chọn</span>
                                </div>
                                <div class="mb-0">
                                    <span class="fw-bold">Tổng tiền:</span>
                                    <span id="summary-price" class="text-danger fw-bold">0 ₫</span>
                                </div>
                            </div>
                            
                            <div class="payment-options mb-3">
                                <h6 class="mb-2">Phương thức thanh toán:</h6>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="payment-method" id="payment-cash" value="cash" checked>
                                    <label class="form-check-label" for="payment-cash">
                                        <i class="fas fa-money-bill-wave text-success me-2"></i>
                                        <span class="fw-bold">Tiền mặt</span>
                                        <div class="text-muted small ms-4">Thanh toán trực tiếp tại sân trước khi sử dụng</div>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment-method" id="payment-vnpay" value="vnpay">
                                    <label class="form-check-label" for="payment-vnpay">
                                        <i class="fas fa-credit-card text-primary me-2"></i>
                                        <span class="fw-bold">VNPAY</span>
                                        <div class="text-muted small ms-4">Thanh toán online qua VNPAY (ATM, Visa, MasterCard, JCB, QR Code)</div>
                                        <div class="text-success small ms-4">
                                            <i class="fas fa-shield-alt me-1"></i>Bảo mật & An toàn
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <button id="booking-submit" class="btn btn-success w-100" disabled>
                                <i class="fas fa-calendar-check me-2"></i>Xác nhận đặt sân
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="fas fa-futbol me-2"></i>Sân Bóng Bình Minh</h5>
                    <p>Hệ thống sân bóng đá chuyên nghiệp với đầy đủ tiện nghi</p>
                </div>
                <div class="col-md-4">
                    <h5><i class="fas fa-link me-2"></i>Liên kết nhanh</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html" class="text-light text-decoration-none"><i class="fas fa-angle-right me-2"></i>Trang chủ</a></li>
                        <li><a href="#" class="text-light text-decoration-none"><i class="fas fa-angle-right me-2"></i>Đặt sân</a></li>
                        <li><a href="my-bookings.html" class="text-light text-decoration-none"><i class="fas fa-angle-right me-2"></i>Sân đã đặt</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5><i class="fas fa-share-alt me-2"></i>Theo dõi chúng tôi</h5>
                    <div class="social-links">
                        <a href="#" class="text-light me-3 fs-4"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="text-light me-3 fs-4"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-light me-3 fs-4"><i class="fab fa-youtube"></i></a>
                        <a href="#" class="text-light fs-4"><i class="fab fa-zalo"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <div class="text-center">
                <p class="mb-0">&copy; 2025 Sân Bóng Bình Minh. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Biến toàn cục
        let pitchData = null;
        let selectedDate = null;
        let selectedTimeSlot = null;
        let availableTimeSlots = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra đăng nhập
            checkLoginStatus();
            
            // Lấy thông tin sân từ URL hoặc localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const pitchId = urlParams.get('pitch') || localStorage.getItem('selectedPitchId');
            
            if (!pitchId) {
                Swal.fire({
                    title: 'Lỗi',
                    text: 'Không tìm thấy thông tin sân',
                    icon: 'error',
                    confirmButtonText: 'Quay lại',
                }).then(() => {
                    window.location.href = 'index.html';
                });
                return;
            }
            
            // Tải thông tin sân
            fetchPitchInfo(pitchId);
            
            // Khởi tạo datepicker
            initializeDatePicker();
            
            // Xử lý sự kiện nút đặt sân
            document.getElementById('booking-submit').addEventListener('click', submitBooking);
        });

        // Kiểm tra trạng thái đăng nhập
        function checkLoginStatus() {
            const token = localStorage.getItem('accessToken');
            const user = JSON.parse(localStorage.getItem('user'));
            
            console.log("Token:", token);
            console.log("User data:", user);
            
            if (!token) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Bạn cần đăng nhập để đặt sân',
                    icon: 'warning',
                    confirmButtonText: 'Đăng nhập ngay',
                }).then(() => {
                    localStorage.setItem('redirectAfterLogin', window.location.href);
                    window.location.href = 'index.html';
                });
                return;
            }
            
            // Lấy thông tin người dùng từ localStorage
            if (user) {
                // Đã đăng nhập, cập nhật thông tin người dùng
                document.getElementById('user-name').textContent = user.fullName || 'Tài khoản';
            } else {
                // Có token nhưng không có thông tin user, thử lấy lại thông tin
                fetch('https://localhost:7290/api/User/current', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Phiên đăng nhập hết hạn');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.data) {
                        // Lưu thông tin người dùng vào localStorage
                        localStorage.setItem('user', JSON.stringify(data.data));
                        document.getElementById('user-name').textContent = data.data.fullName || 'Tài khoản';
                    }
                })
                .catch(error => {
                    console.error('Lỗi xác thực:', error);
                    // Xóa token không hợp lệ
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    
                    Swal.fire({
                        title: 'Phiên đăng nhập hết hạn',
                        text: 'Vui lòng đăng nhập lại',
                        icon: 'warning',
                        confirmButtonText: 'Đăng nhập ngay',
                    }).then(() => {
                        localStorage.setItem('redirectAfterLogin', window.location.href);
                        window.location.href = 'index.html';
                    });
                });
            }
        }

        // Hàm khởi tạo datepicker
        function initializeDatePicker() {
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 30); // Cho phép đặt sân tối đa 30 ngày trước
            
            flatpickr("#booking-date", {
                dateFormat: "d/m/Y",
                minDate: "today",
                maxDate: maxDate,
                locale: "vn",
                disableMobile: true,
                onChange: function(selectedDates) {
                    if (selectedDates.length > 0) {
                        selectedDate = selectedDates[0];
                        fetchTimeSlots(pitchData.pitchID, selectedDate);
                        updateSummary();
                    }
                }
            });
        }

        // Hàm lấy thông tin sân
        async function fetchPitchInfo(pitchId) {
            try {
                // Lấy token xác thực
                const token = localStorage.getItem('accessToken');
                
                const response = await fetch(`https://localhost:7290/api/Pitch/${pitchId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Không thể tải thông tin sân');
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    pitchData = data.data;
                } else if (data.pitchID) {
                    // Trường hợp API trả về trực tiếp dữ liệu mà không có wrapper
                    pitchData = data;
                } else {
                    throw new Error('Dữ liệu sân không hợp lệ');
                }
                
                console.log('Thông tin sân đã tải:', pitchData);
                
                // Kiểm tra và bổ sung thông tin bị thiếu
                if (!pitchData.pitchTypeName && pitchData.pitchType && pitchData.pitchType.name) {
                    pitchData.pitchTypeName = pitchData.pitchType.name;
                    console.log('Đã bổ sung pitchTypeName từ pitchType.name:', pitchData.pitchTypeName);
                }
                
                // Nếu vẫn chưa có pitchTypeName, tải thông tin loại sân từ API khác
                if (!pitchData.pitchTypeName && pitchData.pitchTypeID) {
                    try {
                        const ptResponse = await fetch(`https://localhost:7290/api/PitchType/${pitchData.pitchTypeID}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            }
                        });
                        
                        if (ptResponse.ok) {
                            const ptData = await ptResponse.json();
                            if (ptData && ptData.name) {
                                pitchData.pitchTypeName = ptData.name;
                                console.log('Đã tải pitchTypeName từ API PitchType:', pitchData.pitchTypeName);
                            }
                        }
                    } catch (err) {
                        console.warn('Không thể tải thông tin loại sân:', err);
                    }
                }
                
                // Nếu vẫn không có tên loại sân, gán giá trị mặc định
                if (!pitchData.pitchTypeName) {
                    pitchData.pitchTypeName = 'Sân tiêu chuẩn';
                    console.log('Sử dụng pitchTypeName mặc định:', pitchData.pitchTypeName);
                }
                
                // Cập nhật thông tin sân
                updatePitchInfo();
                
                // Sau khi tải thông tin sân, tiếp tục tải cấu hình khung giờ và giá
                fetchTimeSlotConfig(pitchId);
                
            } catch (error) {
                console.error('Lỗi khi tải thông tin sân:', error);
                Swal.fire({
                    title: 'Lỗi',
                    text: 'Không thể tải thông tin sân: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'Quay lại',
                }).then(() => {
                    window.location.href = 'pitch-list.html';
                });
            }
        }

        // Cập nhật thông tin sân
        function updatePitchInfo() {
            if (!pitchData) return;
            
            // Cập nhật tiêu đề và mô tả
            document.getElementById('pitch-name').textContent = `Đặt sân ${pitchData.name}`;
            
            // Tạo mô tả chi tiết bao gồm loại sân và thông tin liên hệ
            let descriptionText = pitchData.description || 'Sân bóng chất lượng cao';
            
            // Kiểm tra nếu là sân gộp hoặc là một phần của sân gộp
            if (pitchData.description && pitchData.description.startsWith('CombinedFrom:')) {
                // Đây là sân gộp
                const combinedPitchNotice = document.getElementById('combined-pitch-notice');
                if (combinedPitchNotice) {
                    combinedPitchNotice.classList.remove('d-none');
                    combinedPitchNotice.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Đây là sân gộp!</strong> Sân này được tạo bằng cách gộp các sân nhỏ hơn.
                        Khi đặt sân này, bạn sẽ không thể đặt các sân thành phần của nó trong cùng khung giờ.
                    `;
                }
                
                // Loại bỏ phần metadata khỏi description để hiển thị
                const originalDesc = descriptionText.replace(/CombinedFrom:[0-9,]+/, '').trim();
                if (originalDesc) {
                    descriptionText = originalDesc;
                } else {
                    descriptionText = 'Sân bóng gộp chất lượng cao';
                }
            } else {
                // Kiểm tra xem sân này có phải là một phần của sân gộp nào không
                fetch(`https://localhost:7290/api/Pitch/check-combined-parent?pitchId=${pitchData.pitchID}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status !== 404) {
                            console.warn('Không thể kiểm tra thông tin sân gộp:', response.statusText);
                        }
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.isPartOfCombined) {
                        // Đây là một phần của sân gộp
                        const combinedPitchNotice = document.getElementById('combined-pitch-notice');
                        if (combinedPitchNotice) {
                            combinedPitchNotice.classList.remove('d-none');
                            combinedPitchNotice.innerHTML = `
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Lưu ý!</strong> Sân này là một phần của sân gộp ${data.combinedPitchName || ''}. 
                                Khi đặt sân này, bạn sẽ không thể đặt sân gộp trong cùng khung giờ.
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi kiểm tra thông tin sân gộp:', error);
                });
            }
            
            // Thêm thông tin loại sân
            if (pitchData.pitchTypeName) {
                descriptionText += ` | Loại sân: ${pitchData.pitchTypeName}`;
            }
            
            // Thêm thông tin liên hệ (nếu có)
            if (pitchData.phoneNumber) {
                descriptionText += ` | Liên hệ: ${pitchData.phoneNumber}`;
            }
            
            document.getElementById('pitch-description').textContent = descriptionText;
            document.getElementById('summary-pitch-name').textContent = pitchData.name;
            
            // Cập nhật tiêu đề trang
            document.title = `Đặt sân ${pitchData.name} - Sân Bóng Bình Minh`;
        }

        // Hàm lấy cấu hình khung giờ và giá từ API
        async function fetchTimeSlotConfig(pitchId) {
            try {
                // Lấy token xác thực
                const token = localStorage.getItem('accessToken');
                
                const response = await fetch(`https://localhost:7290/api/Pitch/${pitchId}/time-slots`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Không thể tải thông tin khung giờ');
                }
                
                let timeSlotConfig = [];
                const data = await response.json();
                
                if (data.success && Array.isArray(data.data)) {
                    timeSlotConfig = data.data;
                    console.log('Khung giờ từ API:', timeSlotConfig);
                } else if (Array.isArray(data)) {
                    timeSlotConfig = data;
                    console.log('Khung giờ từ API (định dạng mảng):', timeSlotConfig);
                } else {
                    console.log('Định dạng dữ liệu API không đúng, sử dụng cấu hình mặc định');
                    // Sử dụng cấu hình mặc định với giá từ sân đã chọn
                    timeSlotConfig = getDefaultTimeSlots();
                }
                
                // Cập nhật giao diện với thông tin khung giờ
                renderTimeSlots(timeSlotConfig);
                
            } catch (error) {
                console.error('Lỗi khi tải cấu hình khung giờ:', error);
                // Sử dụng cấu hình mặc định với giá từ sân đã chọn
                console.log('Sử dụng cấu hình khung giờ mặc định');
                renderTimeSlots(getDefaultTimeSlots());
            }
        }

        // Hàm tạo ra cấu hình khung giờ mặc định nếu API không có sẵn
        function getDefaultTimeSlots() {
            // Sử dụng giá tiền từ thông tin sân bóng đã chọn
            const basePrice = pitchData && pitchData.price ? pitchData.price : 150000;
            
            // Tính giá cho các khung giờ khác nhau
            const morningPrice = basePrice;
            const afternoonPrice = basePrice;
            const eveningPrice = Math.round(basePrice * 1.2); // Giá buổi tối cao hơn 20%
            
            console.log(`Giá cơ bản của sân: ${basePrice}đ, Giá buổi tối: ${eveningPrice}đ`);
            
            return [
                // Buổi sáng
                { startTime: '06:00:00', endTime: '07:30:00', price: morningPrice, period: 'Sáng' },
                { startTime: '07:30:00', endTime: '09:00:00', price: morningPrice, period: 'Sáng' },
                { startTime: '09:00:00', endTime: '10:30:00', price: morningPrice, period: 'Sáng' },
                
                // Buổi chiều
                { startTime: '13:00:00', endTime: '14:30:00', price: afternoonPrice, period: 'Chiều' },
                { startTime: '14:30:00', endTime: '16:00:00', price: afternoonPrice, period: 'Chiều' },
                { startTime: '16:00:00', endTime: '17:30:00', price: afternoonPrice, period: 'Chiều' },
                
                // Buổi tối
                { startTime: '18:00:00', endTime: '19:30:00', price: eveningPrice, period: 'Tối' },
                { startTime: '19:30:00', endTime: '21:00:00', price: eveningPrice, period: 'Tối' },
                { startTime: '21:00:00', endTime: '22:30:00', price: eveningPrice, period: 'Tối' }
                
            ];
        }

        // Hàm hiển thị các khung giờ lên giao diện
        function renderTimeSlots(timeSlotConfig) {
            // Phân loại khung giờ theo buổi
            const morningSlots = timeSlotConfig.filter(slot => slot.period === 'Sáng');
            const afternoonSlots = timeSlotConfig.filter(slot => slot.period === 'Chiều');
            const eveningSlots = timeSlotConfig.filter(slot => slot.period === 'Tối');
            
            // Tạo HTML cho từng khung giờ
            renderSlotsByPeriod('morning-slots', morningSlots, 'morning-slot');
            renderSlotsByPeriod('afternoon-slots', afternoonSlots, 'afternoon-slot');
            renderSlotsByPeriod('evening-slots', eveningSlots, 'evening-slot');
            
            // Nếu có ngày đã chọn, cập nhật trạng thái các khung giờ
            if (selectedDate) {
                fetchTimeSlots(pitchData.pitchID, selectedDate);
            }
        }

        // Hàm hiển thị khung giờ theo buổi
        function renderSlotsByPeriod(containerId, slots, periodClass) {
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            if (slots.length === 0) {
                container.innerHTML = `<td colspan="8" class="text-center py-3">Không có khung giờ cho buổi này</td>`;
                return;
            }
            
            // Tạo HTML cho các ô khung giờ
            let html = '';
            
            slots.forEach(slot => {
                html += `
                    <td class="text-center py-3 time-slot ${periodClass}" 
                        data-start="${slot.startTime}" 
                        data-end="${slot.endTime}" 
                        data-price="${slot.price}">
                        <div>${formatTime(slot.startTime)} - ${formatTime(slot.endTime)}</div>
                        <div class="text-success fw-bold mt-1">${formatCurrency(slot.price)}</div>
                    </td>
                `;
            });
            
            // Thêm ô trống nếu cần
            const remainingCols = 8 - slots.length;
            if (remainingCols > 0) {
                html += `<td colspan="${remainingCols}"></td>`;
            }
            
            container.innerHTML = html;
        }

        // Hàm lấy danh sách khung giờ có sẵn
        async function fetchTimeSlots(pitchId, date) {
            const timeSlotsTable = document.getElementById('time-slots-table');
            const noTimeSlots = document.getElementById('no-time-slots');
            
            try {
                // Format ngày theo định dạng API
                const formattedDate = formatDateForAPI(date);
                
                // Lấy token từ localStorage
                const token = localStorage.getItem('accessToken');
                
                // Gọi API lấy khung giờ đã được đặt
                const response = await fetch(`https://localhost:7290/api/Booking/booked-slots?pitchId=${pitchId}&date=${formattedDate}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Không thể tải thông tin khung giờ đã đặt');
                }
                
                const data = await response.json();
                
                // Xử lý dữ liệu trả về từ API - danh sách khung giờ đã được đặt
                let bookedSlots = [];
                if (data.success && Array.isArray(data.data)) {
                    bookedSlots = data.data;
                } else if (Array.isArray(data)) {
                    bookedSlots = data.map(slot => ({
                        startTime: slot.startTime,
                        endTime: slot.endTime
                    }));
                } else {
                    console.error('Định dạng dữ liệu API không đúng:', data);
                    bookedSlots = [];
                }
                
                console.log('Khung giờ đã đặt:', bookedSlots);
                
                // Kiểm tra xem có xung đột với sân gộp/thành phần không
                let conflictedSlots = [];
                try {
                    const conflictResponse = await fetch(`https://localhost:7290/api/Booking/get-pitch-conflicts?pitchId=${pitchId}&date=${formattedDate}`, {
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : '',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (conflictResponse.ok) {
                        const conflictData = await conflictResponse.json();
                        
                        if (conflictData.success && Array.isArray(conflictData.data)) {
                            conflictedSlots = conflictData.data;
                        } else if (Array.isArray(conflictData)) {
                            conflictedSlots = conflictData;
                        }
                        
                        console.log('Xung đột khung giờ:', conflictedSlots);
                    } else if (conflictResponse.status !== 404) {
                        console.warn('Không thể kiểm tra xung đột sân:', await conflictResponse.text());
                    }
                } catch (conflictError) {
                    console.warn('Lỗi khi kiểm tra xung đột sân:', conflictError);
                }
                
                // Cập nhật trạng thái các ô trong bảng khung giờ
                updateTimeSlotStatus(bookedSlots, conflictedSlots);
                
            } catch (error) {
                console.error('Lỗi khi tải khung giờ:', error);
                // Hiển thị thông báo lỗi
                Swal.fire({
                    title: 'Lỗi',
                    text: 'Không thể tải thông tin khung giờ: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'Đồng ý'
                });
            }
        }

        // Cập nhật trạng thái các ô trong bảng khung giờ
        function updateTimeSlotStatus(bookedSlots, conflictedSlots = []) {
            const timeSlots = document.querySelectorAll('.time-slot');
            
            // Reset trạng thái của tất cả các ô
            timeSlots.forEach(slot => {
                // Xóa class selected và booked nhưng giữ lại các class buổi (morning-slot, afternoon-slot, evening-slot)
                slot.classList.remove('selected', 'booked', 'unavailable');
            });
            
            // Đánh dấu các khung giờ đã được đặt
            if (bookedSlots && bookedSlots.length > 0) {
                timeSlots.forEach(slot => {
                    const startTime = slot.getAttribute('data-start');
                    const endTime = slot.getAttribute('data-end');
                    
                    // Kiểm tra xem khung giờ này đã được đặt chưa
                    const isBooked = bookedSlots.some(bookedSlot => 
                        bookedSlot.startTime === startTime && bookedSlot.endTime === endTime
                    );
                    
                    // Kiểm tra xem khung giờ có xung đột với sân gộp/thành phần không
                    const hasConflict = conflictedSlots.some(conflictSlot => 
                        conflictSlot.startTime === startTime && conflictSlot.endTime === endTime
                    );
                    
                    if (isBooked) {
                        slot.classList.add('booked');
                        slot.setAttribute('title', 'Đã có người đặt');
                        // Loại bỏ sự kiện click cho khung giờ đã đặt
                        slot.style.pointerEvents = 'none';
                    } else if (hasConflict) {
                        // Nếu có xung đột với sân gộp/thành phần
                        slot.classList.add('conflict');
                        
                        // Tìm thông tin xung đột cụ thể
                        const conflict = conflictedSlots.find(cs => 
                            cs.startTime === startTime && cs.endTime === endTime
                        );
                        
                        if (conflict && conflict.reason) {
                            slot.setAttribute('title', conflict.reason);
                        } else {
                            slot.setAttribute('title', 'Không thể đặt do xung đột với sân gộp hoặc sân thành phần');
                        }
                        
                        // Loại bỏ sự kiện click cho khung giờ xung đột
                        slot.style.pointerEvents = 'none';
                    } else {
                        // Thêm sự kiện click cho khung giờ trống
                        slot.style.pointerEvents = 'auto';
                        slot.setAttribute('title', 'Nhấp để chọn khung giờ này');
                        
                        // Xóa listener cũ nếu có
                        const newSlot = slot.cloneNode(true);
                        slot.parentNode.replaceChild(newSlot, slot);
                        
                        // Nếu đây là slot hiện tại đã chọn, đánh dấu là selected
                        if (selectedTimeSlot && 
                            selectedTimeSlot.startTime === startTime && 
                            selectedTimeSlot.endTime === endTime) {
                            newSlot.classList.add('selected');
                        }
                        
                        newSlot.addEventListener('click', function() {
                            // Nếu slot này đã được chọn, bỏ chọn nó
                            if (this.classList.contains('selected')) {
                                this.classList.remove('selected');
                                selectedTimeSlot = null;
                                updateSummary();
                                return;
                            }
                            
                            // Bỏ chọn tất cả các slot trước khi chọn slot mới
                            document.querySelectorAll('.time-slot').forEach(s => {
                                s.classList.remove('selected');
                            });
                            
                            // Chọn slot này
                            this.classList.add('selected');
                            
                            // Lưu thông tin đã chọn
                            selectedTimeSlot = {
                                startTime: this.getAttribute('data-start'),
                                endTime: this.getAttribute('data-end'),
                                price: parseFloat(this.getAttribute('data-price'))
                            };
                            
                            // Cập nhật thông tin
                            updateSummary();
                        });
                    }
                });
            } else {
                // Nếu không có dữ liệu khung giờ đã đặt, kiểm tra xung đột
                timeSlots.forEach(slot => {
                    const startTime = slot.getAttribute('data-start');
                    const endTime = slot.getAttribute('data-end');
                    
                    // Kiểm tra xem khung giờ có xung đột với sân gộp/thành phần không
                    const hasConflict = conflictedSlots.some(conflictSlot => 
                        conflictSlot.startTime === startTime && conflictSlot.endTime === endTime
                    );
                    
                    if (hasConflict) {
                        // Nếu có xung đột với sân gộp/thành phần
                        slot.classList.add('conflict');
                        
                        // Tìm thông tin xung đột cụ thể
                        const conflict = conflictedSlots.find(cs => 
                            cs.startTime === startTime && cs.endTime === endTime
                        );
                        
                        if (conflict && conflict.reason) {
                            slot.setAttribute('title', conflict.reason);
                        } else {
                            slot.setAttribute('title', 'Không thể đặt do xung đột với sân gộp hoặc sân thành phần');
                        }
                        
                        // Loại bỏ sự kiện click cho khung giờ xung đột
                        slot.style.pointerEvents = 'none';
                    } else {
                    // Xóa listener cũ nếu có
                    const newSlot = slot.cloneNode(true);
                    slot.parentNode.replaceChild(newSlot, slot);
                    
                    // Nếu đây là slot hiện tại đã chọn, đánh dấu là selected
                    if (selectedTimeSlot && 
                        selectedTimeSlot.startTime === newSlot.getAttribute('data-start') && 
                        selectedTimeSlot.endTime === newSlot.getAttribute('data-end')) {
                        newSlot.classList.add('selected');
                    }
                    
                    newSlot.addEventListener('click', function() {
                        // Nếu slot này đã được chọn, bỏ chọn nó
                        if (this.classList.contains('selected')) {
                            this.classList.remove('selected');
                            selectedTimeSlot = null;
                            updateSummary();
                            return;
                        }
                        
                        // Bỏ chọn tất cả các slot trước khi chọn slot mới
                        document.querySelectorAll('.time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // Chọn slot này
                        this.classList.add('selected');
                        
                        // Lưu thông tin đã chọn
                        selectedTimeSlot = {
                            startTime: this.getAttribute('data-start'),
                            endTime: this.getAttribute('data-end'),
                            price: parseFloat(this.getAttribute('data-price'))
                        };
                        
                        // Cập nhật thông tin
                        updateSummary();
                    });
                    }
                });
            }
            
            console.log('Đã cập nhật trạng thái khung giờ, khung giờ đã chọn:', selectedTimeSlot);
        }

        // Cập nhật thông tin tóm tắt đặt sân
        function updateSummary() {
            const summaryDate = document.getElementById('summary-date');
            const summaryTime = document.getElementById('summary-time');
            const summaryPrice = document.getElementById('summary-price');
            const bookingSubmit = document.getElementById('booking-submit');
            
            if (selectedDate) {
                summaryDate.textContent = formatDate(selectedDate);
            } else {
                summaryDate.textContent = 'Chưa chọn';
            }
            
            if (selectedTimeSlot) {
                summaryTime.textContent = `${formatTime(selectedTimeSlot.startTime)} - ${formatTime(selectedTimeSlot.endTime)}`;
                summaryPrice.textContent = formatCurrency(selectedTimeSlot.price);
                bookingSubmit.disabled = false;
            } else {
                summaryTime.textContent = 'Chưa chọn';
                summaryPrice.textContent = '0 ₫';
                bookingSubmit.disabled = true;
            }
        }

        // Cập nhật UI sau khi đặt sân thành công
        function updateBookingSuccess(bookingData) {
            // Cập nhật thông tin đặt sân
            localStorage.setItem('lastBooking', JSON.stringify({
                id: bookingData.bookingID,
                pitchName: pitchData.name,
                date: formatDate(selectedDate),
                time: `${formatTime(selectedTimeSlot.startTime)} - ${formatTime(selectedTimeSlot.endTime)}`,
                price: selectedTimeSlot.price
            }));
            
            // Hiển thị thông báo thành công
            Swal.fire({
                title: 'Đặt sân thành công!',
                text: 'Bạn có muốn xem thông tin đặt sân?',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'Xem đặt sân',
                cancelButtonText: 'Đặt sân khác'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'my-bookings.html';
                } else {
                    // Làm mới trang
                    window.location.reload();
                }
            });
        }

        // Gửi yêu cầu đặt sân
        async function submitBooking() {
            if (!selectedDate || !selectedTimeSlot || !pitchData) {
                Swal.fire({
                    title: 'Thông tin chưa đủ',
                    text: 'Vui lòng chọn đầy đủ ngày và giờ',
                    icon: 'warning',
                    confirmButtonText: 'Đồng ý'
                });
                return;
            }
            
            try {
                // Hiển thị loading
                Swal.fire({
                    title: 'Đang xử lý',
                    text: 'Vui lòng đợi...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Định dạng thời gian cho API
                const bookingDate = new Date(selectedDate);
                // Đặt giờ thành 12:00 để tránh vấn đề múi giờ
                bookingDate.setHours(12, 0, 0, 0);
                
                // Lấy token từ localStorage
                const token = localStorage.getItem('accessToken');
                
                if (!token) {
                    throw new Error('Bạn cần đăng nhập để đặt sân');
                }
                
                // Kiểm tra khả dụng của sân trước khi đặt
                const checkAvailabilityUrl = `https://localhost:7290/api/Booking/check-availability?pitchId=${pitchData.pitchID}&date=${formatDateForAPI(bookingDate)}&startTime=${selectedTimeSlot.startTime}&endTime=${selectedTimeSlot.endTime}`;
                
                const availabilityResponse = await fetch(checkAvailabilityUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const availabilityResult = await availabilityResponse.json();
                if (!availabilityResponse.ok) {
                    if (availabilityResponse.status === 401) {
                        // Token hết hạn
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('user');
                        throw new Error('Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.');
                    }
                    throw new Error(availabilityResult.message || 'Không thể kiểm tra khả dụng của sân');
                }
                
                if (!availabilityResult.data) {
                    throw new Error('Sân đã được đặt trong khung giờ này. Vui lòng chọn khung giờ khác.');
                }
                
                // Kiểm tra xem sân có phải là một phần của sân gộp nào không
                // hoặc nếu đây là sân gộp, kiểm tra xem các sân thành phần đã có người đặt chưa
                const conflictCheckResponse = await fetch(`https://localhost:7290/api/Booking/check-pitch-conflicts?pitchId=${pitchData.pitchID}&date=${formatDateForAPI(bookingDate)}&startTime=${selectedTimeSlot.startTime}&endTime=${selectedTimeSlot.endTime}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!conflictCheckResponse.ok) {
                    if (conflictCheckResponse.status === 404) {
                        // API chưa có endpoint này, tiếp tục đặt sân bình thường
                        console.warn('API kiểm tra xung đột sân gộp chưa được triển khai');
                    } else {
                        throw new Error('Không thể kiểm tra thông tin sân gộp');
                    }
                } else {
                    const conflictResult = await conflictCheckResponse.json();
                    
                    if (conflictResult.hasConflict) {
                        // Có xung đột với sân gộp hoặc sân thành phần
                        throw new Error(conflictResult.message || 'Không thể đặt sân do xung đột với sân gộp hoặc sân thành phần');
                    }
                    
                    // Nếu API trả về thông tin cảnh báo, hiển thị cho người dùng
                    if (conflictResult.warning) {
                        const warningConfirm = await Swal.fire({
                            title: 'Cảnh báo',
                            text: conflictResult.warning,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Vẫn đặt sân',
                            cancelButtonText: 'Hủy'
                        });
                        
                        if (!warningConfirm.isConfirmed) {
                            // Người dùng chọn hủy
                            Swal.close();
                            return;
                        }
                    }
                }
                
                // Chuẩn bị dữ liệu theo cấu trúc của API
                const bookingData = {
                    booking: {
                        pitchID: pitchData.pitchID,
                        bookingDate: bookingDate.toISOString(),
                        startTime: selectedTimeSlot.startTime,
                        endTime: selectedTimeSlot.endTime,
                        totalPrice: selectedTimeSlot.price,
                        note: document.getElementById('booking-note').value || ''
                    },
                    payment: {
                        paymentMethod: document.querySelector('input[name="payment-method"]:checked').value === 'cash' ? 'Tiền mặt ' : 'VNPAY',
                        amount: selectedTimeSlot.price
                    }
                };
                
                console.log('Dữ liệu gửi đi:', bookingData);
                
                // Gọi API đặt sân
                const response = await fetch('https://localhost:7290/api/Booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(bookingData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token hết hạn
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('user');
                        throw new Error('Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.');
                    }
                    throw new Error(result.message || 'Đặt sân không thành công');
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Đặt sân không thành công');
                }
                
                // Lấy ID đặt sân
                const bookingId = result.data.bookingID;
                
                // Kiểm tra phương thức thanh toán
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                
                if (paymentMethod === 'vnpay') {
                    // Chuyển hướng đến trang thanh toán VNPAY
                    try {
                        const vnpayResponse = await fetch(`https://localhost:7290/api/Vnpay/CreatePaymentUrl?bookingId=${bookingId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (!vnpayResponse.ok) {
                            // Đã đặt sân nhưng không thể tạo URL thanh toán
                            throw new Error('Không thể tạo đường dẫn thanh toán. Vui lòng vào mục Sân đã đặt để thanh toán sau.');
                        }
                        
                        const vnpayResult = await vnpayResponse.json();
                        
                        if (vnpayResult.success && vnpayResult.data) {
                            // Chuyển hướng đến trang thanh toán VNPAY
                            window.location.href = vnpayResult.data;
                            return;
                        } else {
                            throw new Error(vnpayResult.message || 'Không thể tạo đường dẫn thanh toán');
                        }
                    } catch (vnpayError) {
                        // Đã đặt sân nhưng có lỗi khi tạo URL thanh toán, vẫn hiển thị thông báo đặt sân thành công
                        console.error('Lỗi khi tạo URL thanh toán:', vnpayError);
                        
                        Swal.fire({
                            title: 'Đặt sân thành công!',
                            text: 'Tuy nhiên, có lỗi khi chuyển hướng đến trang thanh toán. ' + vnpayError.message,
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonText: 'Xem sân đã đặt',
                            cancelButtonText: 'Đặt sân khác'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = 'my-bookings.html';
                            } else {
                                window.location.reload();
                            }
                        });
                        
                        return;
                    }
                } else if (paymentMethod === 'cash') {
                    // Thanh toán tiền mặt - tạo payment mới qua API
                    try {
                        const paymentData = {
                            bookingID: bookingId,
                            amount: selectedTimeSlot.price,
                            paymentMethod: 'Tiền mặt',
                            transactionID: 'null'
                            
                        };
                        
                        const paymentResponse = await fetch('https://localhost:7290/api/Payments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(paymentData)
                        });
                        
                        if (!paymentResponse.ok) {
                            console.warn('Không thể tạo bản ghi thanh toán, nhưng đặt sân vẫn thành công');
                        }
                    } catch (paymentError) {
                        console.error('Lỗi khi tạo bản ghi thanh toán:', paymentError);
                    }
                }
                
                // Phương thức thanh toán tại sân hoặc không có lỗi khi tạo URL thanh toán
                // Cập nhật thông tin đặt sân
                localStorage.setItem('lastBooking', JSON.stringify({
                    id: result.data.bookingID,
                    pitchName: pitchData.name,
                    date: formatDate(selectedDate),
                    time: `${formatTime(selectedTimeSlot.startTime)} - ${formatTime(selectedTimeSlot.endTime)}`,
                    price: selectedTimeSlot.price
                }));
                
                // Hiển thị thông báo thành công
                Swal.fire({
                    title: 'Đặt sân thành công!',
                    text: 'Bạn có muốn xem thông tin đặt sân?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'Xem đặt sân',
                    cancelButtonText: 'Đặt sân khác'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'my-bookings.html';
                    } else {
                        // Làm mới trang
                        window.location.reload();
                    }
                });
                
            } catch (error) {
                console.error('Lỗi khi đặt sân:', error);
                
                if (error.message.includes('đăng nhập')) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: error.message,
                        icon: 'warning',
                        confirmButtonText: 'Đăng nhập ngay',
                    }).then(() => {
                        localStorage.setItem('redirectAfterLogin', window.location.href);
                        window.location.href = 'index.html';
                    });
                } else {
                    Swal.fire({
                        title: 'Lỗi',
                        text: 'Không thể đặt sân: ' + error.message,
                        icon: 'error',
                        confirmButtonText: 'Đồng ý'
                    });
                }
            }
        }

        // Hàm định dạng ngày cho API (yyyy-MM-dd)
        function formatDateForAPI(date) {
            if (!date) return '';
            const d = new Date(date);
            // Đặt giờ thành 12:00 để tránh vấn đề múi giờ
            d.setHours(12, 0, 0, 0);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Hàm định dạng ngày hiển thị (dd/MM/yyyy)
        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Hàm định dạng giờ (HH:mm)
        function formatTime(timeString) {
            if (!timeString) return '';
            // Chuyển "17:30:00" thành "17:30"
            return timeString.substring(0, 5);
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm đăng xuất
        function logout() {
            // Xóa tất cả dữ liệu đăng nhập từ localStorage
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            localStorage.removeItem('userID');
            localStorage.removeItem('userEmail');
            
            // Chuyển hướng về trang chủ
            window.location.href = 'index.html';
        }
    </script>
</body>
</html> 