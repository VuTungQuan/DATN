<!DOCTYPE html>
<html lang="en">

<head>
    <title> Admin Dashbroad </title>
    
    <!-- HTML5 Shim and Respond.js IE9 support of HTML5 elements and media queries -->
    <!-- Include bcryptjs from CDN -->   
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js" defer></script-->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <![endif]-->
      <!-- Meta -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="description" content="CodedThemes">
      <meta name="keywords" content=" Admin , Responsive, Landing, Bootstrap, App, Template, Mobile, iOS, Android, apple, creative app">
      <meta name="author" content="CodedThemes">
      <!-- Favicon icon -->
      <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
      <!-- Google font-->
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet">
      <!-- Required Fremwork -->
      <link rel="stylesheet" type="text/css" href="assets/css/bootstrap/css/bootstrap.min.css">
      <!-- themify-icons line icon -->
      <link rel="stylesheet" type="text/css" href="assets/icon/themify-icons/themify-icons.css">
      <!-- ico font -->
      <link rel="stylesheet" type="text/css" href="assets/icon/icofont/css/icofont.css">
      <!-- Style.css -->
      <link rel="stylesheet" type="text/css" href="assets/css/style.css">
      <link rel="stylesheet" type="text/css" href="assets/css/jquery.mCustomScrollbar.css">
      <!-- SweetAlert2 CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
      <!-- SweetAlert2 JS -->
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  </head>

  <body>
    
    <!-- Pre-loader start -->
    <div class="theme-loader">
        <div class="ball-scale">
            <div class='contain'>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">

                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pre-loader end -->
    <div id="pcoded" class="pcoded">
        <div class="pcoded-overlay-box"></div>
        <div class="pcoded-container navbar-wrapper">

            <nav class="navbar header-navbar pcoded-header">
                <div class="navbar-wrapper">

                    <div class="navbar-logo">
                        <a class="mobile-menu" id="mobile-collapse" href="#!">
                            <i class="ti-menu"></i>
                        </a>
                        <a class="mobile-search morphsearch-search" href="#">
                            <i class="ti-search"></i>
                        </a>
                        <a href="index.html">
                            <img class="img-fluid" src="assets/images/logo.png" alt="Theme-Logo" />
                        </a>
                        <a class="mobile-options">
                            <i class="ti-more"></i>
                        </a>
                    </div>

                    <div class="navbar-container container-fluid">
                        <ul class="nav-left">
                            <li>
                                <div class="sidebar_toggle"><a href="javascript:void(0)"><i class="ti-menu"></i></a></div>
                            </li>

                            <li>
                                <a href="#!" onclick="javascript:toggleFullScreen()">
                                    <i class="ti-fullscreen"></i>
                                </a>
                            </li>
                        </ul>
                        <ul class="nav-right">
                            <li class="header-notification">
                                <a href="#!">
                                    <i class="ti-bell"></i>
                                    <span class="badge bg-c-pink"></span>
                                </a>
                                <ul class="show-notification">
                                    <li>
                                        <h6>Notifications</h6>
                                        <label class="label label-danger">New</label>
                                    </li>
                                    <li>
                                        <div class="media">
                                            <img class="d-flex align-self-center img-radius" src="assets/images/avatar-4.jpg" alt="Generic placeholder image">
                                            <div class="media-body">
                                                <h5 class="notification-user">John Doe</h5>
                                                <p class="notification-msg">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                                <span class="notification-time">30 minutes ago</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="media">
                                            <img class="d-flex align-self-center img-radius" src="assets/images/avatar-3.jpg" alt="Generic placeholder image">
                                            <div class="media-body">
                                                <h5 class="notification-user">Joseph William</h5>
                                                <p class="notification-msg">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                                <span class="notification-time">30 minutes ago</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="media">
                                            <img class="d-flex align-self-center img-radius" src="assets/images/avatar-4.jpg" alt="Generic placeholder image">
                                            <div class="media-body">
                                                <h5 class="notification-user">Sara Soudein</h5>
                                                <p class="notification-msg">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                                <span class="notification-time">30 minutes ago</span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            <!-- Header phần tài khoản -->
                            <li class="user-profile header-notification">
                                <a href="#!">
                                    <img src="assets/images/avatar-4.jpg" class="img-radius" alt="User-Profile-Image">
                                    <span id="userDropdown">Admin</span>
                                    <i class="ti-angle-down"></i>
                                </a>
                                <ul class="show-notification profile-notification" id="user-menu">
                                    <li>
                                        <a href="#!">
                                            <i class="ti-settings"></i> Cài đặt
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <i class="ti-user"></i> Thông tin cá nhân
                                        </a>
                                    </li>
                                    <li>
                                        <a href="../index.html">
                                            <i class="ti-layout-sidebar-left"></i> Đăng xuất
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div class="pcoded-main-container">
                <div class="pcoded-wrapper">
                    <nav class="pcoded-navbar">
                        <div class="sidebar_toggle"><a href="#"><i class="icon-close icons"></i></a></div>
                        <div class="pcoded-inner-navbar main-menu">
                            <div class="pcoded-search">
                                <span class="searchbar-toggle">  </span>
                                <div class="pcoded-search-box ">
                                    <input type="text" placeholder="Search">
                                    <span class="search-icon"><i class="ti-search" aria-hidden="true"></i></span>
                                </div>
                            </div>
                            <div class="pcoded-navigatio-lavel" data-i18n="nav.category.navigation">Layout</div>
                            <ul class="pcoded-item pcoded-left-item">
                                <li class="active">
                                    <a href="index.html">
                                        <span class="pcoded-micon"><i class="ti-home"></i><b>D</b></span>
                                        <span class="pcoded-mtext" data-i18n="nav.dash.main">Dashboard</span>
                                        <span class="pcoded-mcaret"></span>
                                    </a>
                                </li>
                                <li class="pcoded-hasmenu">
                                    <a href="javascript:void(0)">
                                        <span class="pcoded-micon"><i class="ti-layout-grid2-alt"></i></span>
                                        <span class="pcoded-mtext"  data-i18n="nav.basic-components.main">Quản lý</span>
                                        <span class="pcoded-mcaret"></span>
                                    </a>
                                    <ul class="pcoded-submenu">
                                        <li class=" ">
                                            <a href="account.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.alert">Tài khoản</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="pitch.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.breadcrumbs">Sân bóng</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="pitchtype.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.breadcrumbs">Loại sân</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="booking.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.alert">Đặt sân</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="payment.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.breadcrumbs">Thanh toán</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                    <div class="pcoded-content">
                        <div class="pcoded-inner-content">
                            <div class="main-body">
                                <div class="page-wrapper">
                                    <div class="page-body">
                                        <div class="row">                                    
                                            <!-- Quản lý Đặt Sân Start -->
                                            <div class="container mt-5">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="card-header-text" style="color: #2ed8b6;">Quản Lý Đặt Sân</h5>
                                                        <button id="refreshData" class="btn btn-primary float-right">
                                                            <i class="ti-reload"></i> Làm mới
                                                        </button>
                                                </div>
                                                    <div class="card-block">
                                                        <div class="row mb-3">
                                                            <div class="col-md-2">
                                                                <label>Từ ngày:</label>
                                                                <input type="date" id="fromDate" class="form-control">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>Đến ngày:</label>
                                                                <input type="date" id="toDate" class="form-control">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>Trạng thái đặt sân:</label>
                                                                <select id="statusFilter" class="form-control">
                                                                    <option value="">Tất cả</option>
                                                                    <option value="Pending">Chờ xác nhận</option>
                                                                    <option value="Confirmed">Đã xác nhận</option>
                                                                    <option value="Completed">Hoàn thành</option>
                                                                    <option value="Cancelled">Đã hủy</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>Sân:</label>
                                                                <select id="pitchFilter" class="form-control">
                                                                    <option value="">Tất cả</option>
                                                                    <!-- Danh sách sân được thêm bằng JS -->
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>Thanh toán:</label>
                                                                <select id="paymentFilter" class="form-control">
                                                                    <option value="">Tất cả</option>
                                                                    <option value="paid">Đã thanh toán</option>
                                                                    <option value="unpaid">Chưa thanh toán</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label>Tìm khách hàng:</label>
                                                                <input type="text" id="customerFilter" class="form-control" placeholder="Tên hoặc SĐT...">
                                                            </div>
                                                        </div>
                                                        <div class="row mb-3">
                                                            <div class="col-md-10">
                                                                <div id="activeFilters" class="d-flex flex-wrap">
                                                                    <!-- Các bộ lọc đang áp dụng sẽ hiển thị ở đây -->
                                                                </div>
                                                            </div>
                                                            <div class="col-md-2 d-flex">
                                                                <button id="searchButton" class="btn btn-primary flex-grow-1 mr-1">
                                                                    <i class="ti-search mr-1"></i> Tìm kiếm
                                                                </button>
                                                                <button id="resetFilters" class="btn btn-secondary">
                                                                    <i class="ti-reload"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <style>
                                                            #activeFilters .badge {
                                                                font-size: 0.85rem;
                                                                font-weight: normal;
                                                            }
                                                            
                                                            .badge-info {
                                                                background-color: #4099ff;
                                                            }
                                                            
                                                            .filter-badge {
                                                                display: inline-flex;
                                                                align-items: center;
                                                            }
                                                            
                                                            .filter-badge .remove-filter {
                                                                margin-left: 5px;
                                                                cursor: pointer;
                                                                font-size: 12px;
                                                                opacity: 0.7;
                                                            }
                                                            
                                                            .filter-badge .remove-filter:hover {
                                                                opacity: 1;
                                                            }
                                                        </style>
                                                        
                                                        <div class="table-responsive">
                                                            <table class="table table-hover">
                                                    <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                                        <th>Khách hàng</th>
                                                                        <th>Sân</th>
                                                                        <th>Ngày đặt</th>
                                                                        <th>Giờ đặt</th>
                                                                        <th>Tổng tiền</th>
                                                                        <th>Trạng thái</th>
                                                                        <th>Thao tác</th>
                                                    </tr>
                                                    </thead>
                                                                <tbody id="bookingTableBody">
                                                                    <!-- Dữ liệu đặt sân sẽ được thêm vào đây -->
                                                    </tbody>
                                                </table>
                                                        </div>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div class="pagination-info"></div>
                                                            <ul class="pagination" id="bookingPagination">
                                                                <!-- Phân trang sẽ được thêm vào đây -->
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Quản lý Đặt Sân End -->

                                            <!-- Modal Chi tiết đặt sân -->
                                            <div class="modal fade" id="bookingDetailModal" tabindex="-1" role="dialog">
                                                <div class="modal-dialog modal-lg" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Chi tiết đặt sân</h5>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <h6>Thông tin đặt sân</h6>
                                                                    <div class="table-responsive">
                                                                        <table class="table table-bordered">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>ID đặt sân:</strong></td>
                                                                                    <td id="detail-bookingId"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Ngày đặt:</strong></td>
                                                                                    <td id="detail-bookingDate"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Thời gian:</strong></td>
                                                                                    <td id="detail-time"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Sân:</strong></td>
                                                                                    <td id="detail-pitch"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Loại sân:</strong></td>
                                                                                    <td id="detail-pitchType"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Tổng tiền:</strong></td>
                                                                                    <td id="detail-totalPrice"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Ghi chú:</strong></td>
                                                                                    <td id="detail-note"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Trạng thái:</strong></td>
                                                                                    <td><span id="detail-status" class="badge badge-pill"></span></td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6>Thông tin khách hàng</h6>
                                                                    <div class="table-responsive">
                                                                        <table class="table table-bordered">
                                                                            <tbody id="detail-userInfo">
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>Họ tên:</strong></td>
                                                                                    <td id="detail-userName"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Số điện thoại:</strong></td>
                                                                                    <td id="detail-phone"></td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Email:</strong></td>
                                                                                    <td id="detail-email"></td>
                                                                                </tr>
                                                                                <!-- Các thông tin khác sẽ được thêm tự động từ API -->
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <hr>
                                                            <div class="row" id="payment-info">
                                                                <div class="col-md-12">
                                                                    <h6>Thông tin thanh toán</h6>
                                                                    <div class="table-responsive">
                                                                        <table class="table table-bordered">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td style="width: 30%;"><strong>Trạng thái:</strong></td>
                                                                                    <td>
                                                                                        <span id="detail-paymentStatus" class="badge badge-pill"></span>
                                                                                        <span id="detail-paymentInfo" class="small ml-2 text-muted"></span>
                                                                                    </td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Phương thức:</strong></td>
                                                                                    <td id="detail-paymentMethod">-</td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Số tiền:</strong></td>
                                                                                    <td id="detail-paymentAmount">-</td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Mã giao dịch:</strong></td>
                                                                                    <td id="detail-transactionId">-</td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td><strong>Ngày thanh toán:</strong></td>
                                                                                    <td id="detail-paymentDate">-</td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <div id="action-buttons">
                                                                <button type="button" id="confirmButton" class="btn btn-success">Xác nhận</button>
                                                                <button type="button" id="completeButton" class="btn btn-info">Hoàn thành</button>
                                                                <button type="button" id="cancelButton" class="btn btn-danger">Hủy đặt sân</button>
                                                            </div>
                                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        
                                            
                                    <div id="styleSelector">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!-- Thêm thư viện jQuery và Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
<!-- Required Jquery -->
<script type="text/javascript" src="assets/js/jquery/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="assets/js/popper.js/popper.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap/js/bootstrap.min.js"></script>
<!-- jquery slimscroll js -->
<script type="text/javascript" src="assets/js/jquery-slimscroll/jquery.slimscroll.js"></script>
<!-- modernizr js -->
<script type="text/javascript" src="assets/js/modernizr/modernizr.js"></script>
<!-- am chart -->
<script src="assets/pages/widget/amchart/amcharts.min.js"></script>
<script src="assets/pages/widget/amchart/serial.min.js"></script>
<!-- Todo js -->
<script type="text/javascript " src="assets/pages/todo/todo.js "></script>
<!-- Custom js -->
<script type="text/javascript" src="assets/pages/dashboard/custom-dashboard.js"></script>
<script type="text/javascript" src="assets/js/script.js"></script>
<script type="text/javascript " src="assets/js/SmoothScroll.js"></script>
<script src="assets/js/pcoded.min.js"></script>
<script src="assets/js/demo-12.js"></script>
<script src="assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
<script>
    // Khai báo các biến toàn cục
    let currentPage = 1;
let itemsPerPage = 10;
    let totalItems = 0;
let currentBookingId = 0;
    // Biến kiểm tra xem API có hỗ trợ tìm kiếm khách hàng hay không
    let apiSupportsCustomerSearch = null;

    // Hàm format tiền tệ VND
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    };

// Format ngày tháng
const formatDate = (dateString) => {
    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
    return new Date(dateString).toLocaleDateString('vi-VN', options);
};

// Format thời gian
const formatTime = (timeString) => {
    if (!timeString) return '';
    // Chuyển "17:30:00" thành "17:30"
    return timeString.substring(0, 5);
};

// Hàm lấy class cho badge trạng thái
const getStatusBadgeClass = (status) => {
    switch (status) {
        case 'Pending': return 'badge-warning';
        case 'Confirmed': return 'badge-primary';
        case 'Completed': return 'badge-success';
        case 'Cancelled': return 'badge-danger';
        default: return 'badge-secondary';
    }
};

// Hàm lấy text hiển thị cho trạng thái
const getStatusText = (status) => {
    switch (status) {
        case 'Pending': return 'Chờ xác nhận';
        case 'Confirmed': return 'Đã xác nhận';
        case 'Completed': return 'Hoàn thành';
        case 'Cancelled': return 'Đã hủy';
        default: return status;
    }
};

// Hàm lấy text hiển thị cho phương thức thanh toán
const getPaymentMethodText = (method) => {
    switch (method) {
        case 'Cash': return 'Thanh toán tiền mặt tại sân';
        case 'VNPAY': 
        case 'VnPay': return 'Thanh toán qua VNPAY';
        case 'Bank Transfer': return 'Chuyển khoản ngân hàng';
        default: return method || 'Chưa có thông tin';
    }
};

// Hàm lấy biểu tượng cho phương thức thanh toán
const getPaymentMethodIcon = (method) => {
    switch (method) {
        case 'Cash': return '<i class="ti-money text-success mr-1"></i>';
        case 'VNPAY': 
        case 'VnPay': return '<i class="ti-credit-card text-primary mr-1"></i>';
        case 'Bank Transfer': return '<i class="ti-exchange-vertical text-info mr-1"></i>';
        default: return '<i class="ti-help-alt text-muted mr-1"></i>';
    }
};

// Kiểm tra xem DOM đã sẵn sàng
    document.addEventListener('DOMContentLoaded', function () {
    console.log("DOM đã sẵn sàng, đang khởi tạo trang quản lý đặt sân");
    
    // Thêm sự kiện cho nút làm mới dữ liệu
    document.getElementById('refreshData').addEventListener('click', function() {
        loadBookings();
    });
    
    // Thêm sự kiện cho nút reset bộ lọc
    document.getElementById('resetFilters').addEventListener('click', function() {
        resetAllFilters();
    });
    
    // Thêm sự kiện enter cho input tìm kiếm khách hàng
    document.getElementById('customerFilter').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            loadBookings();
        }
    });
    
        const token = localStorage.getItem('accessToken');
    console.log("Token hiện tại:", token ? "Có token" : "Không có token");
    
    if (!token) {
        console.error("Chưa có access token");
        Swal.fire({
            icon: 'error',
            title: 'Lỗi xác thực',
            text: 'Bạn cần đăng nhập để sử dụng tính năng này',
            confirmButtonText: 'Đăng nhập'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '../index.html';
            }
        });
        return;
    }
    
    try {
            const decodedToken = decodeToken(token);
        console.log("Token đã giải mã:", decodedToken);
        
        // Kiểm tra token hết hạn
        const currentTime = Math.floor(Date.now() / 1000);
        if (decodedToken.exp && decodedToken.exp < currentTime) {
            console.error("Token đã hết hạn");
            Swal.fire({
                icon: 'error',
                title: 'Phiên làm việc hết hạn',
                text: 'Vui lòng đăng nhập lại',
                confirmButtonText: 'Đăng nhập'
            }).then(() => {
                localStorage.removeItem('accessToken');
                window.location.href = '../index.html';
            });
            return;
        }
        
            const role = decodedToken.role;
        console.log("Vai trò người dùng:", role);

            if (role === 'Admin') {
                // Lấy thông tin admin từ API và cập nhật giao diện
                const email = decodedToken.email;
                getUserInfoByEmail(email);
        
            // Khởi tạo ngày mặc định (7 ngày qua)
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('fromDate').valueAsDate = weekAgo;
            document.getElementById('toDate').valueAsDate = today;
            
            // Tải danh sách sân
                loadPitches();
            // Tải danh sách đặt sân
            loadBookings();
            
            // Thêm sự kiện cho nút tìm kiếm
            document.getElementById('searchButton').addEventListener('click', loadBookings);
            } else {
            console.error("Người dùng không phải là Admin:", role);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi quyền truy cập',
                text: 'Bạn cần đăng nhập với tài khoản Admin để sử dụng tính năng này',
                confirmButtonText: 'Đăng nhập lại'
            }).then(() => {
                localStorage.removeItem('accessToken');
                window.location.href = '../index.html';
            });
        }
    } catch (error) {
        console.error("Lỗi xử lý token:", error);
        Swal.fire({
            icon: 'error', 
            title: 'Lỗi xác thực',
            text: 'Token không hợp lệ: ' + error.message,
            confirmButtonText: 'Đăng nhập lại'
        }).then(() => {
            localStorage.removeItem('accessToken');
            window.location.href = '../index.html';
        });
        } 
    });

    // Hàm giải mã JWT
    function decodeToken(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    } catch (error) {
        console.error("Lỗi giải mã token:", error);
        throw new Error("Token không hợp lệ hoặc sai định dạng");
    }
    }

    // Hàm lấy thông tin người dùng từ email sau khi đăng nhập
    async function getUserInfoByEmail(email) {
        try {
            const encodedEmail = encodeURIComponent(email);
        const response = await fetch(`https://localhost:7290/api/Users/email/${encodedEmail}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const userData = await response.json();
                const userDropdown = document.getElementById('userDropdown');
                if (userDropdown) {
                    userDropdown.innerText = userData.fullName || 'Admin';
                }
                
                const userMenu = document.getElementById('user-menu');
                if (userMenu) {
                    userMenu.style.display = 'block';
                }
        } else {
                console.error('Không thể lấy thông tin người dùng');
            }
        } catch (error) {
            console.error('Lỗi:', error);
        }
    }

// Hàm tải danh sách sân để hiển thị filter
const loadPitches = async () => {
        try {
        const response = await fetch('https://localhost:7290/api/Pitch', {
                headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });
        if (!response.ok) throw new Error('Không thể tải danh sách sân');
        
            const data = await response.json();
        console.log("Dữ liệu sân:", data);
        
        // Xử lý đúng cấu trúc phản hồi API mới
        let pitches = [];
        if (data.success) {
            // API mới trả về cấu trúc dạng { success: true, items: [...], ... }
            pitches = data.items || [];
        } else if (Array.isArray(data)) {
            // API cũ trả về trực tiếp mảng
            pitches = data;
        } else if (data.items && Array.isArray(data.items)) {
            // Cấu trúc khác có thể có
            pitches = data.items;
        }
        
        // Cập nhật select filter sân
        const pitchSelect = document.getElementById('pitchFilter');
        if (pitchSelect) {
            const options = pitches.map(pitch => 
                `<option value="${pitch.pitchID}">${pitch.name}</option>`
                ).join('');
                
            // Giữ lại option "Tất cả" và thêm các options mới
            pitchSelect.innerHTML = `<option value="">Tất cả</option>${options}`;
            }
        } catch (error) {
        console.error('Lỗi tải danh sách sân:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
            text: 'Không thể tải danh sách sân: ' + error.message
            });
        }
    };

// Hàm tải danh sách đặt sân
const loadBookings = async () => {
    try {
        // Lấy thông tin filter
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        const status = document.getElementById('statusFilter').value;
        const pitchId = document.getElementById('pitchFilter').value;
        const paymentStatus = document.getElementById('paymentFilter').value;
        const customerSearch = document.getElementById('customerFilter').value.trim();
        
        // Lưu lại giá trị tìm kiếm khách hàng cho lọc phía client
        const customerSearchValue = customerSearch.toLowerCase();
        
        // Hiển thị các bộ lọc đang áp dụng
        updateActiveFilters(fromDate, toDate, status, pitchId, paymentStatus, customerSearch);
        
        // Lấy tham chiếu tới bảng
        const tbody = document.getElementById('bookingTableBody');
        
        // Hiển thị loading
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Đang tải...</span>
                        </div>
                        <div>Đang tải dữ liệu...</div>
                    </td>
                </tr>
            `;
        }

        // Tạo URL với các tham số filter
        let url = `https://localhost:7290/api/Booking?pageNumber=${currentPage}&pageSize=${itemsPerPage}`;
        
        // Chỉ thêm tham số khi có giá trị
        if (fromDate) {
            const formattedFromDate = new Date(fromDate).toISOString().split('T')[0];
            url += `&fromDate=${formattedFromDate}`;
        }
        
        if (toDate) {
            const formattedToDate = new Date(toDate).toISOString().split('T')[0];
            url += `&toDate=${formattedToDate}`;
        }
        
        if (status) url += `&status=${encodeURIComponent(status)}`;
        if (pitchId && pitchId !== '') url += `&pitchId=${pitchId}`;
        if (paymentStatus) url += `&paymentStatus=${encodeURIComponent(paymentStatus)}`;
        
        // Chỉ thêm tham số tìm kiếm khách hàng nếu API hỗ trợ
        if (customerSearch) {
            if (apiSupportsCustomerSearch !== false) {
                // Thử cả hai tham số để tìm cái nào hoạt động
                url += `&customerSearch=${encodeURIComponent(customerSearch)}`;
                // Thêm cả searchTerm vì không biết backend dùng tham số nào
                url += `&searchTerm=${encodeURIComponent(customerSearch)}`;
            } else {
                console.log("Bỏ qua tham số tìm kiếm khách hàng trong API vì server không hỗ trợ");
            }
        }
        
        console.log("Đang gọi API:", url);
        
        // Gọi API
        let response;
        try {
            // DEBUG: Kiểm tra API endpoint
            const backendEndpoint = 'https://localhost:7290/api/Booking';
            const debugUrl = new URL(url);
            const apiUrl = new URL(backendEndpoint);
            
            // Sao chép các tham số từ URL ban đầu
            for (const [key, value] of new URLSearchParams(debugUrl.search)) {
                apiUrl.searchParams.set(key, value);
            }
            
            const finalUrl = apiUrl.toString();
            console.log("Final API URL:", finalUrl);
            
            response = await fetch(finalUrl, {
                method: 'GET', 
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });
        } catch (networkError) {
            console.error("Lỗi mạng:", networkError);
            throw new Error("Không thể kết nối tới server. Vui lòng kiểm tra kết nối mạng của bạn.");
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Lỗi API:", response.status, errorText);
            throw new Error(`Không thể tải danh sách đặt sân: ${response.status} ${errorText}`);
        }
        
            const data = await response.json();
        console.log("Dữ liệu API trả về:", data);
        
        // Kiểm tra xem API có hỗ trợ tìm kiếm khách hàng không
        if (customerSearch && apiSupportsCustomerSearch === null) {
            // Nếu có kết quả và ít hơn tổng số, có thể API đã lọc theo khách hàng
            if (data.items && data.items.length < data.totalItems) {
                console.log("API có vẻ hỗ trợ tìm kiếm khách hàng.");
                apiSupportsCustomerSearch = true;
            } else {
                console.log("API có vẻ không hỗ trợ tìm kiếm khách hàng, sẽ lọc phía client.");
                apiSupportsCustomerSearch = false;
            }
        }
        
        // Xử lý đúng cấu trúc phản hồi API mới
        if (!data.success) {
            throw new Error(data.message || 'Không thể tải danh sách đặt sân');
        }
        
        // Lấy dữ liệu từ cấu trúc phản hồi mới
        const bookings = data.items || [];
        totalItems = data.totalItems || 0;
        const pageNumber = data.pageNumber || 1;
        const totalPages = data.totalPages || 1;
        
        console.log("Số lượng booking:", bookings.length);
        
        // Nếu đang tìm kiếm theo khách hàng nhưng API không hỗ trợ, thực hiện lọc phía client
        let filteredBookings = bookings;
        if (customerSearchValue && apiSupportsCustomerSearch === false) {
            console.log("Thực hiện tìm kiếm phía client với từ khóa:", customerSearchValue);
            filteredBookings = bookings.filter(booking => {
                const userName = (booking.userName || '').toLowerCase();
                const phone = (booking.phoneNumber || '').toLowerCase();
                return userName.includes(customerSearchValue) || phone.includes(customerSearchValue);
            });
            console.log("Kết quả tìm kiếm phía client:", filteredBookings.length, "kết quả");
        }
            
        // Nếu đang tìm kiếm phía client, hiển thị thông báo
        if (customerSearchValue && apiSupportsCustomerSearch === false && filteredBookings.length !== bookings.length) {
            const clientFilterNotice = document.createElement('div');
            clientFilterNotice.className = 'alert alert-info mb-3 mt-2';
            clientFilterNotice.innerHTML = `
                <i class="ti-info-alt mr-1"></i> 
                Đang lọc theo tên/số điện thoại: 
                <strong>${customerSearchValue}</strong>. 
                Hiển thị ${filteredBookings.length} / ${bookings.length} kết quả.
            `;
            document.querySelector('.table-responsive').before(clientFilterNotice);
        }
            
            // Hiển thị dữ liệu
            if (tbody) {
            tbody.innerHTML = '';
            
            if (filteredBookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">Không có dữ liệu đặt sân</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filteredBookings.map(booking => `
                    <tr>
                        <td>${booking.bookingID}</td>
                        <td>${booking.userName}<br><small>${booking.phoneNumber || 'N/A'}</small></td>
                        <td>${booking.pitchName || 'N/A'}<br><small>${booking.pitchTypeName || 'N/A'}</small></td>
                        <td>${formatDate(booking.bookingDate)}</td>
                        <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                        <td>${formatCurrency(booking.totalPrice)}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(booking.status)}">${getStatusText(booking.status)}</span>
                            
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewBookingDetail(${booking.bookingID})">
                                <i class="ti-eye"></i> Chi tiết
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Hiển thị thông tin kết quả
            const paginationInfo = document.querySelector('.pagination-info');
            if (paginationInfo) {
                paginationInfo.innerHTML = `Hiển thị ${filteredBookings.length} trên ${totalItems} đặt sân`;
            }
        } else {
            console.error("Không tìm thấy element #bookingTableBody");
            }
            
            // Cập nhật phân trang
        updatePagination(pageNumber, totalPages);
        
        } catch (error) {
        console.error('Lỗi tải danh sách đặt sân:', error);
        const tbodyError = document.getElementById('bookingTableBody');
        if (tbodyError) {
            tbodyError.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">Lỗi: ${error.message}</td>
                </tr>
            `;
        }
        
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
            text: 'Không thể tải danh sách đặt sân: ' + error.message
            });
        }
    };

// Hiển thị trạng thái thanh toán cho mỗi đặt sân
function getPaymentBadge(booking) {
    if (!booking.payment) {
        return '<span class="badge badge-secondary ml-1">Chưa thanh toán</span>';
    }
    
    const isPaid = booking.payment.paymentDate && booking.payment.transactionID && 
                 !booking.payment.paymentDate.startsWith('0001-01-01');
    
    if (isPaid) {
        return '<span class="badge badge-success ml-1">Đã thanh toán</span>';
    } else {
        return '<span class="badge badge-warning ml-1">Chưa thanh toán</span>';
    }
}

// Hiển thị các bộ lọc đang áp dụng
function updateActiveFilters(fromDate, toDate, status, pitchId, paymentStatus, customerSearch) {
    const activeFilters = document.getElementById('activeFilters');
    activeFilters.innerHTML = '';
    
    const filters = [];
    
    if (fromDate) {
        filters.push({
            type: 'fromDate',
            text: `Từ ngày: ${formatDate(new Date(fromDate))}`
        });
    }
    
    if (toDate) {
        filters.push({
            type: 'toDate',
            text: `Đến ngày: ${formatDate(new Date(toDate))}`
        });
    }
    
    if (status) {
        filters.push({
            type: 'status',
            text: `Trạng thái: ${getStatusText(status)}`
        });
    }
    
    if (pitchId) {
        const pitchSelect = document.getElementById('pitchFilter');
        const selectedOption = pitchSelect.options[pitchSelect.selectedIndex];
        if (selectedOption) {
            filters.push({
                type: 'pitchId',
                text: `Sân: ${selectedOption.text}`
            });
        }
    }
    
    if (paymentStatus) {
        filters.push({
            type: 'paymentStatus',
            text: `Thanh toán: ${paymentStatus === 'paid' ? 'Đã thanh toán' : 'Chưa thanh toán'}`
        });
    }
    
    if (customerSearch) {
        filters.push({
            type: 'customerSearch',
            text: `Tìm kiếm: "${customerSearch}"`
        });
    }
    
    if (filters.length === 0) {
        activeFilters.innerHTML = '<span class="badge badge-light p-2 mr-2 mb-2">Không có bộ lọc nào được áp dụng</span>';
        return;
    }
    
    filters.forEach(filter => {
        const badge = document.createElement('div');
        badge.className = 'badge badge-info p-2 mr-2 mb-2 filter-badge';
        badge.innerHTML = `
            ${filter.text}
            <i class="ti-close remove-filter" data-filter="${filter.type}"></i>
        `;
        
        // Thêm sự kiện xóa bộ lọc
        const removeBtn = badge.querySelector('.remove-filter');
        removeBtn.addEventListener('click', function() {
            removeFilter(this.getAttribute('data-filter'));
        });
        
        activeFilters.appendChild(badge);
    });
}

// Hàm xóa một bộ lọc cụ thể
function removeFilter(filterType) {
    switch(filterType) {
        case 'fromDate':
            document.getElementById('fromDate').value = '';
            break;
        case 'toDate':
            document.getElementById('toDate').value = '';
            break;
        case 'status':
            document.getElementById('statusFilter').value = '';
            break;
        case 'pitchId':
            document.getElementById('pitchFilter').value = '';
            break;
        case 'paymentStatus':
            document.getElementById('paymentFilter').value = '';
            break;
        case 'customerSearch':
            document.getElementById('customerFilter').value = '';
            break;
    }
    
    // Sau khi xóa bộ lọc, tải lại dữ liệu
    loadBookings();
}

// Hàm reset tất cả các bộ lọc
function resetAllFilters() {
    // Đặt lại giá trị mặc định cho các bộ lọc
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('pitchFilter').value = '';
    document.getElementById('paymentFilter').value = '';
    document.getElementById('customerFilter').value = '';
    
    // Reset trang về 1
    currentPage = 1;
    
    // Cập nhật UI và tải lại dữ liệu
    const activeFilters = document.getElementById('activeFilters');
    activeFilters.innerHTML = '<span class="badge badge-light p-2 mr-2 mb-2">Không có bộ lọc nào được áp dụng</span>';
    
    // Tải lại dữ liệu
    loadBookings();
}

// Hàm cập nhật phân trang
const updatePagination = (currentPage, totalPages) => {
    const pagination = document.getElementById('bookingPagination');
        
        let paginationHTML = '';
        
        // Nút Previous
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Trước </a>
            </li>
        `;
        
        // Các nút số trang
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>
            `;
        }
        
        // Nút Next
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Sau</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
};

// Hàm chuyển trang
function changePage(page) {
    console.log("Chuyển đến trang:", page);
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (page < 1 || page > totalPages) return;
        currentPage = page;
    loadBookings();
}

// Hàm xem chi tiết đặt sân
function viewBookingDetail(bookingId) {
    try {
        // Hiển thị loading
        Swal.fire({
            title: 'Đang tải...',
            text: 'Vui lòng đợi trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Gọi API lấy chi tiết đặt sân
        fetch(`https://localhost:7290/api/Booking/${bookingId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Không thể lấy thông tin đặt sân');
            return response.json();
        })
        .then(async result => {
            // Đóng thông báo loading
            Swal.close();
            
            console.log("Chi tiết đặt sân:", result);
            
            // Kiểm tra cấu trúc phản hồi
            if (!result.success && !result.bookingID) {
                throw new Error(result.message || 'Không thể lấy thông tin đặt sân');
            }
            
            const booking = result.data || result;
            currentBookingId = bookingId;
            
            // Cập nhật thông tin đặt sân vào modal
            document.getElementById('detail-bookingId').textContent = booking.bookingID;
            document.getElementById('detail-bookingDate').textContent = formatDate(booking.bookingDate);
            document.getElementById('detail-time').textContent = `${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}`;
            document.getElementById('detail-pitch').textContent = booking.pitchName || 'Không có thông tin';
            document.getElementById('detail-pitchType').textContent = booking.pitchTypeName || 'Không có thông tin';
            document.getElementById('detail-totalPrice').textContent = formatCurrency(booking.totalPrice);
            document.getElementById('detail-note').textContent = booking.note || 'Không có ghi chú';

            // Hiển thị trạng thái với badge
            const statusElement = document.getElementById('detail-status');
            statusElement.textContent = getStatusText(booking.status);
            statusElement.className = `badge badge-pill ${getStatusBadgeClass(booking.status)}`;
            
            // Thông tin khách hàng
            document.getElementById('detail-userName').textContent = booking.userName || 'Không có thông tin';
            document.getElementById('detail-phone').textContent = booking.phoneNumber || 'Không có thông tin';
            document.getElementById('detail-email').textContent = booking.email || 'Không có thông tin';
            console.log(booking.userID);
            // Lấy thông tin chi tiết về người dùng từ API
            if (booking.userID) {
                try {
                    const userResponse = await fetch(`https://localhost:7290/api/Users/${booking.userID}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                        }
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        console.log('Dữ liệu người dùng:', userData);
                        
                        // Cập nhật thông tin chi tiết người dùng trực tiếp từ kết quả API
                        // API trả về userData trực tiếp, không có cấu trúc success/data
                        if (userData) {
                            document.getElementById('detail-userName').textContent = userData.fullName || booking.userName || 'Không có thông tin';
                            document.getElementById('detail-phone').textContent = userData.phoneNumber || booking.phoneNumber || 'Không có thông tin';
                            document.getElementById('detail-email').textContent = userData.email || booking.email || 'Không có thông tin';
                            
                            // Thêm trường thông tin người dùng khác nếu cần
                            const userInfoContainer = document.querySelector('#detail-userInfo');
                            if (userInfoContainer) {
                                // Thêm địa chỉ nếu có
                                if (userData.address) {
                                    // Kiểm tra nếu chưa có dòng địa chỉ
                                    const existingAddressRow = userInfoContainer.querySelector('#user-address-row');
                                    if (!existingAddressRow) {
                                        const addressRow = document.createElement('tr');
                                        addressRow.id = 'user-address-row';
                                        addressRow.innerHTML = `
                                            <td style="width: 40%;"><strong>Địa chỉ:</strong></td>
                                            <td>${userData.address}</td>
                                        `;
                                        userInfoContainer.appendChild(addressRow);
                                    }
                                }
                            }
                        }
                    } else {
                        console.warn('Không thể lấy thông tin chi tiết người dùng:', await userResponse.text());
                    }
                } catch (userError) {
                    console.error('Lỗi khi lấy thông tin người dùng:', userError);
                }
            }
            
            // Thông tin thanh toán
            const paymentInfo = document.getElementById('payment-info');
            if (booking.payment) {
                paymentInfo.style.display = 'block';
                
                // Cập nhật trạng thái thanh toán
                const paymentStatus = document.getElementById('detail-paymentStatus');
                const paymentInfoText = document.getElementById('detail-paymentInfo');
                const isPaid = booking.payment.paymentDate && booking.payment.transactionID;
                
                if (isPaid) {
                    paymentStatus.textContent = 'Đã thanh toán';
                    paymentStatus.className = 'badge badge-pill badge-success';
                    paymentInfoText.innerHTML = `<i class="ti-calendar mr-1"></i>${formatDate(booking.payment.paymentDate)}`;
                } else {
                    paymentStatus.textContent = 'Chưa thanh toán';
                    paymentStatus.className = 'badge badge-pill badge-warning';
                    paymentInfoText.innerHTML = '';
                }
                
                // Cập nhật các thông tin khác
                const paymentMethod = booking.payment.paymentMethod || 'Chưa có thông tin';
                document.getElementById('detail-paymentMethod').innerHTML = 
                    getPaymentMethodIcon(paymentMethod) + getPaymentMethodText(paymentMethod);
                
                // Kiểm tra và xử lý số tiền thanh toán
                const paymentAmount = booking.payment.amount || booking.totalPrice;
                document.getElementById('detail-paymentAmount').textContent = formatCurrency(paymentAmount > 0 ? paymentAmount : booking.totalPrice);
                
                document.getElementById('detail-transactionId').textContent = booking.payment.transactionID || 'Chưa có';
                
                // Kiểm tra và xử lý ngày thanh toán
                document.getElementById('detail-paymentDate').textContent = isPaid ? formatDate(booking.payment.paymentDate) : 'Chưa thanh toán';
            } else {
                // Nếu không có thông tin thanh toán, vẫn hiển thị phần thanh toán nhưng với trạng thái chưa có
                paymentInfo.style.display = 'block';
                
                const paymentStatus = document.getElementById('detail-paymentStatus');
                const paymentInfoText = document.getElementById('detail-paymentInfo');
                paymentStatus.textContent = 'Chưa có thông tin';
                paymentStatus.className = 'badge badge-pill badge-secondary';
                paymentInfoText.innerHTML = '';
                
                // Đặt các giá trị mặc định
                document.getElementById('detail-paymentMethod').innerHTML = getPaymentMethodIcon() + 'Chưa có thông tin';
                document.getElementById('detail-paymentAmount').textContent = formatCurrency(booking.totalPrice);
                document.getElementById('detail-transactionId').textContent = 'Chưa có';
                document.getElementById('detail-paymentDate').textContent = 'Chưa thanh toán';
            }
            
            // Hiện/ẩn các nút tương ứng với trạng thái
            const confirmButton = document.getElementById('confirmButton');
            const completeButton = document.getElementById('completeButton');
            const cancelButton = document.getElementById('cancelButton');
            
            switch (booking.status) {
                case 'Pending':
                    confirmButton.style.display = 'inline-block';
                    completeButton.style.display = 'none';
                    cancelButton.style.display = 'inline-block';
                    break;
                case 'Confirmed':
                    confirmButton.style.display = 'none';
                    completeButton.style.display = 'inline-block';
                    cancelButton.style.display = 'inline-block';
                    break;
                case 'Completed':
                case 'Cancelled':
                    confirmButton.style.display = 'none';
                    completeButton.style.display = 'none';
                    cancelButton.style.display = 'none';
                    break;
                default:
                    confirmButton.style.display = 'none';
                    completeButton.style.display = 'none';
                    cancelButton.style.display = 'none';
            }
            
            // Hiển thị modal
            $('#bookingDetailModal').modal('show');
        })
        .catch(error => {
            console.error('Lỗi xem chi tiết đặt sân:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: error.message || 'Không thể lấy thông tin chi tiết đặt sân'
            });
        });
    } catch (error) {
        console.error('Lỗi xem chi tiết đặt sân:', error);
        Swal.fire({
            icon: 'error',
            title: 'Lỗi!',
            text: error.message || 'Không thể lấy thông tin chi tiết đặt sân'
        });
    }
}

// Xác nhận đặt sân
document.getElementById('confirmButton').addEventListener('click', async () => {
    try {
        // Hiển thị loading
        Swal.fire({
            title: 'Đang xử lý...',
            text: 'Vui lòng đợi trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const token = localStorage.getItem('accessToken');
        if (!token) {
            throw new Error('Bạn chưa đăng nhập. Vui lòng đăng nhập lại.');
        }
        
        console.log("Gọi API xác nhận đặt sân:", currentBookingId);
        console.log("Token:", token.substring(0, 20) + "...");
        
        const response = await fetch(`https://localhost:7290/api/Booking/${currentBookingId}/confirm`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log("API Response Status:", response.status);
        
        if (response.status === 403) {
            throw new Error('Bạn không có quyền thực hiện thao tác này. Vui lòng đăng nhập với tài khoản quản trị.');
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Lỗi API:", response.status, errorText);
            throw new Error(`Lỗi: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log("Kết quả xác nhận:", result);
        
        if (!result.success) {
            throw new Error(result.message || 'Không thể xác nhận đặt sân');
        }
        
        // Đóng modal trước khi hiện thông báo
        $('#bookingDetailModal').modal('hide');
        
        // Sau đó hiển thị thông báo thành công
        Swal.fire({
            icon: 'success',
            title: 'Thành công!',
            text: 'Đã xác nhận đặt sân'
        }).then(() => {
            loadBookings();
        });
    } catch (error) {
        console.error('Lỗi xác nhận đặt sân:', error);
        Swal.fire({
            icon: 'error',
            title: 'Lỗi!',
            text: error.message || 'Không thể xác nhận đặt sân'
        });
    }
});

// Hoàn thành đặt sân
document.getElementById('completeButton').addEventListener('click', async () => {
    try {
        // Hiển thị loading
        Swal.fire({
            title: 'Đang xử lý...',
            text: 'Vui lòng đợi trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const token = localStorage.getItem('accessToken');
        if (!token) {
            throw new Error('Bạn chưa đăng nhập. Vui lòng đăng nhập lại.');
        }
        
        console.log("Gọi API hoàn thành đặt sân:", currentBookingId);
        
        const response = await fetch(`https://localhost:7290/api/Booking/${currentBookingId}/complete`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log("API Response Status:", response.status);
        
        if (response.status === 403) {
            throw new Error('Bạn không có quyền thực hiện thao tác này. Vui lòng đăng nhập với tài khoản quản trị.');
        }

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Lỗi API:", response.status, errorText);
            throw new Error(`Lỗi: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log("Kết quả hoàn thành:", result);
        
        if (!result.success) {
            throw new Error(result.message || 'Không thể hoàn thành đặt sân');
        }
        
        // Đóng modal trước khi hiện thông báo
        $('#bookingDetailModal').modal('hide');
        
        // Sau đó hiển thị thông báo thành công
        Swal.fire({
            icon: 'success',
            title: 'Thành công!',
            text: 'Đã đánh dấu hoàn thành đặt sân'
        }).then(() => {
            loadBookings();
        });
    } catch (error) {
        console.error('Lỗi hoàn thành đặt sân:', error);
        Swal.fire({
            icon: 'error',
            title: 'Lỗi!',
            text: error.message || 'Không thể hoàn thành đặt sân'
        });
    }
});

// Hủy đặt sân
document.getElementById('cancelButton').addEventListener('click', async () => {
    try {
        // Hiển thị hộp thoại xác nhận
        const result = await Swal.fire({
            title: 'Xác nhận hủy?',
            text: 'Bạn có chắc chắn muốn hủy đặt sân này?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Hủy đặt sân',
            cancelButtonText: 'Quay lại'
        });
        
        if (!result.isConfirmed) return;
        
        // Hiển thị loading
        Swal.fire({
            title: 'Đang xử lý...',
            text: 'Vui lòng đợi trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const token = localStorage.getItem('accessToken');
        if (!token) {
            throw new Error('Bạn chưa đăng nhập. Vui lòng đăng nhập lại.');
        }
        
        console.log("Gọi API hủy đặt sân:", currentBookingId);
        
        const response = await fetch(`https://localhost:7290/api/Booking/${currentBookingId}/cancel`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log("API Response Status:", response.status);
        
        if (response.status === 403) {
            throw new Error('Bạn không có quyền thực hiện thao tác này. Vui lòng đăng nhập với tài khoản quản trị.');
        }

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Lỗi API:", response.status, errorText);
            throw new Error(`Lỗi: ${response.status} - ${errorText}`);
        }
        
        const responseData = await response.json();
        console.log("Kết quả hủy:", responseData);
        
        if (!responseData.success) {
            throw new Error(responseData.message || 'Không thể hủy đặt sân');
        }
        
        // Đóng modal trước khi hiện thông báo
        $('#bookingDetailModal').modal('hide');
        
        // Sau đó hiển thị thông báo thành công
        Swal.fire({
            icon: 'success',
            title: 'Thành công!',
            text: 'Đã hủy đặt sân'
        }).then(() => {
            loadBookings();
        });
    } catch (error) {
        console.error('Lỗi hủy đặt sân:', error);
        Swal.fire({
            icon: 'error',
            title: 'Lỗi!',
            text: error.message || 'Không thể hủy đặt sân'
        });
    }
});
</script>
</body>
</html>