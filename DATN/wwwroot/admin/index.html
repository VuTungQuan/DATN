<!DOCTYPE html>
<html lang="en">

<head>
    <title> Admin Dashbroad </title>
    <!-- HTML5 Shim and Respond.js IE9 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <![endif]-->
      <!-- Meta -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="description" content="CodedThemes">
      <meta name="keywords" content=" Admin , Responsive, Landing, Bootstrap, App, Template, Mobile, iOS, Android, apple, creative app">
      <meta name="author" content="CodedThemes">
      <!-- Favicon icon -->
      <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
      <!-- Google font-->
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet">
      <!-- Required Fremwork -->
      <link rel="stylesheet" type="text/css" href="assets/css/bootstrap/css/bootstrap.min.css">
      <!-- themify-icons line icon -->
      <link rel="stylesheet" type="text/css" href="assets/icon/themify-icons/themify-icons.css">
      <!-- ico font -->
      <link rel="stylesheet" type="text/css" href="assets/icon/icofont/css/icofont.css">
      <!-- Style.css -->
      <link rel="stylesheet" type="text/css" href="assets/css/style.css">
      <link rel="stylesheet" type="text/css" href="assets/css/jquery.mCustomScrollbar.css">
  </head>

  <body>
    <!-- Pre-loader start -->
    <div class="theme-loader">
        <div class="ball-scale">
            <div class='contain'>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">

                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pre-loader end -->
    <div id="pcoded" class="pcoded">
        <div class="pcoded-overlay-box"></div>
        <div class="pcoded-container navbar-wrapper">

            <nav class="navbar header-navbar pcoded-header">
                <div class="navbar-wrapper">

                    <div class="navbar-logo">
                        <a class="mobile-menu" id="mobile-collapse" href="#!">
                            <i class="ti-menu"></i>
                        </a>
                        <a class="mobile-search morphsearch-search" href="#">
                            <i class="ti-search"></i>
                        </a>
                        <a href="index.html">
                            <img class="img-fluid" src="assets/images/logo.png" alt="Theme-Logo" />
                        </a>
                        <a class="mobile-options">
                            <i class="ti-more"></i>
                        </a>
                    </div>

                    <div class="navbar-container container-fluid">
                        <ul class="nav-left">
                            <li>
                                <div class="sidebar_toggle"><a href="javascript:void(0)"><i class="ti-menu"></i></a></div>
                            </li>

                            <li>
                                <a href="#!" onclick="javascript:toggleFullScreen()">
                                    <i class="ti-fullscreen"></i>
                                </a>
                            </li>
                        </ul>
                        <ul class="nav-right">
                            <li class="header-notification">
                                <a href="#!">
                                    <i class="ti-bell"></i>
                                    <span class="badge bg-c-pink"></span>
                                </a>
                                <ul class="show-notification">
                                    <li>
                                        <h6>Notifications</h6>
                                        <label class="label label-danger">New</label>
                                    </li>
                                    <li>
                                        <div class="media">
                                            <img class="d-flex align-self-center img-radius" src="assets/images/avatar-4.jpg" alt="Generic placeholder image">
                                            <div class="media-body">
                                                <h5 class="notification-user">John Doe</h5>
                                                <p class="notification-msg">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                                <span class="notification-time">30 minutes ago</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="media">
                                            <img class="d-flex align-self-center img-radius" src="assets/images/avatar-3.jpg" alt="Generic placeholder image">
                                            <div class="media-body">
                                                <h5 class="notification-user">Joseph William</h5>
                                                <p class="notification-msg">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                                <span class="notification-time">30 minutes ago</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="media">
                                            <img class="d-flex align-self-center img-radius" src="assets/images/avatar-4.jpg" alt="Generic placeholder image">
                                            <div class="media-body">
                                                <h5 class="notification-user">Sara Soudein</h5>
                                                <p class="notification-msg">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                                <span class="notification-time">30 minutes ago</span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            <!-- Header phần tài khoản -->
                            <li class="user-profile header-notification">
                                <a href="#!">
                                    <img src="assets/images/avatar-4.jpg" class="img-radius" alt="User-Profile-Image">
                                    <span id="userDropdown">Admin</span>
                                    <i class="ti-angle-down"></i>
                                </a>
                                <ul class="show-notification profile-notification" id="user-menu">
                                    
                                    <li>
                                        <a href="#">
                                            <i class="ti-user"></i> Thông tin cá nhân
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" onclick="logout()">
                                            <i class="ti-layout-sidebar-left"></i> Đăng xuất
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div class="pcoded-main-container">
                <div class="pcoded-wrapper">
                    <nav class="pcoded-navbar">
                        <div class="sidebar_toggle"><a href="#"><i class="icon-close icons"></i></a></div>
                        <div class="pcoded-inner-navbar main-menu">
                            <div class="pcoded-search">
                                <span class="searchbar-toggle">  </span>
                                <div class="pcoded-search-box ">
                                    <input type="text" placeholder="Search">
                                    <span class="search-icon"><i class="ti-search" aria-hidden="true"></i></span>
                                </div>
                            </div>
                            <div class="pcoded-navigatio-lavel" data-i18n="nav.category.navigation">Layout</div>
                            <ul class="pcoded-item pcoded-left-item">
                                <li class="active">
                                    <a href="index.html">
                                        <span class="pcoded-micon"><i class="ti-home"></i><b>D</b></span>
                                        <span class="pcoded-mtext" data-i18n="nav.dash.main">Dashboard</span>
                                        <span class="pcoded-mcaret"></span>
                                    </a>
                                </li>
                                <li class="pcoded-hasmenu">
                                    <a href="javascript:void(0)">
                                        <span class="pcoded-micon"><i class="ti-layout-grid2-alt"></i></span>
                                        <span class="pcoded-mtext"  data-i18n="nav.basic-components.main">Quản lý</span>
                                        <span class="pcoded-mcaret"></span>
                                    </a>
                                    <ul class="pcoded-submenu">
                                        <li class=" ">
                                            <a href="account.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.alert">Tài khoản</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="pitch.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.breadcrumbs">Sân bóng</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="pitchtype.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.breadcrumbs">Loại sân</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="booking.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.alert">Đặt sân </span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                        <li class=" ">
                                            <a href="payment.html">
                                                <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                <span class="pcoded-mtext" data-i18n="nav.basic-components.breadcrumbs">Giảm giá</span>
                                                <span class="pcoded-mcaret"></span>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                    <div class="pcoded-content">
                        <div class="pcoded-inner-content">
                            <div class="main-body">
                                <div class="page-wrapper">
                                    <div class="page-body">
                                        <div class="row">                                    
                                            <!-- Statestics Start -->
                                            <div class="col-xl-3 col-md-6">
                                                <div class="card">
                                                    <div class="card-block">
                                                        <div class="row align-items-center">
                                                            <div class="col-8">
                                                                <h4 class="text-c-purple" id="totalRevenue">0 ₫</h4>
                                                                <h6 class="text-muted m-b-0">Tổng doanh thu</h6>
                                                            </div>
                                                            <div class="col-4 text-right">
                                                                <i class="ti-money f-28"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer bg-c-purple">
                                                        <div class="row align-items-center">
                                                            <div class="col-9">
                                                                <p class="text-white m-b-0" id="revenueChangeText">Tăng 0%</p>
                                                            </div>
                                                            <div class="col-3 text-right">
                                                                <i class="ti-arrow-up text-white f-16" id="revenueChangeIcon"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xl-3 col-md-6">
                                                <div class="card">
                                                    <div class="card-block">
                                                        <div class="row align-items-center">
                                                            <div class="col-8">
                                                                <h4 class="text-c-green" id="totalBookings">0</h4>
                                                                <h6 class="text-muted m-b-0">Lượt đặt sân</h6>
                                                            </div>
                                                            <div class="col-4 text-right">
                                                                <i class="ti-calendar f-28"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer bg-c-green">
                                                        <div class="row align-items-center">
                                                            <div class="col-9">
                                                                <p class="text-white m-b-0" id="bookingsChangeText">Tăng 0%</p>
                                                            </div>
                                                            <div class="col-3 text-right">
                                                                <i class="ti-arrow-up text-white f-16" id="bookingsChangeIcon"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xl-3 col-md-6">
                                                <div class="card">
                                                    <div class="card-block">
                                                        <div class="row align-items-center">
                                                            <div class="col-8">
                                                                <h4 class="text-c-red" id="totalUsers">0</h4>
                                                                <h6 class="text-muted m-b-0">Người dùng</h6>
                                                            </div>
                                                            <div class="col-4 text-right">
                                                                <i class="ti-user f-28"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer bg-c-red">
                                                        <div class="row align-items-center">
                                                            <div class="col-9">
                                                                <p class="text-white m-b-0" id="usersChangeText">Tăng 0%</p>
                                                            </div>
                                                            <div class="col-3 text-right">
                                                                <i class="ti-arrow-up text-white f-16" id="usersChangeIcon"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xl-3 col-md-6">
                                                <div class="card">
                                                    <div class="card-block">
                                                        <div class="row align-items-center">
                                                            <div class="col-8">
                                                                <h4 class="text-c-blue" id="averageRevenue">0 ₫</h4>
                                                                <h6 class="text-muted m-b-0">Trung bình/đặt</h6>
                                                            </div>
                                                            <div class="col-4 text-right">
                                                                <i class="ti-bar-chart f-28"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer bg-c-blue">
                                                        <div class="row align-items-center">
                                                            <div class="col-9">
                                                                <p class="text-white m-b-0" id="averageChangeText">Tăng 0%</p>
                                                            </div>
                                                            <div class="col-3 text-right">
                                                                <i class="ti-arrow-up text-white f-16" id="averageChangeIcon"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Statestics End -->
                                            
                                            <!-- Revenue Chart Start -->
                                            <div class="col-md-12 col-xl-8">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5>Biểu đồ doanh thu</h5>
                                                        <div class="card-header-right">
                                                            <ul class="list-unstyled card-option">
                                                                <li><i class="fa fa-chevron-left"></i></li>
                                                                <li><i class="fa fa-window-maximize full-card"></i></li>
                                                                <li><i class="fa fa-minus minimize-card"></i></li>
                                                                <li><i class="fa fa-refresh reload-card"></i></li>
                                                            </ul>
                                                        </div>
                                                        <div class="mt-3">
                                                            <select id="revenueChartPeriod" class="form-control" style="width: 150px; display: inline-block;">
                                                                <option value="week">7 ngày qua</option>
                                                                <option value="month">30 ngày qua</option>
                                                                <option value="year">12 tháng qua</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="card-block">
                                                        <canvas id="revenueChart" style="height: 400px;"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Payment Method Stats -->
                                            <div class="col-md-12 col-xl-4">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5>Phương thức thanh toán</h5>
                                                    </div>
                                                    <div class="card-block">
                                                        <canvas id="paymentMethodChart" style="height: 400px;"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Recent Bookings -->
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5>Đặt sân gần đây</h5>
                                                    </div>
                                                    <div class="card-block table-border-style">
                                                        <div class="table-responsive">
                                                            <table class="table table-hover">
                                                                <thead>
                                                                    <tr>
                                                                        <th>ID</th>
                                                                        <th>Khách hàng</th>
                                                                        <th>Sân</th>
                                                                        <th>Ngày đặt</th>
                                                                        <th>Thời gian</th>
                                                                        <th>Tổng tiền</th>
                                                                        <th>Trạng thái</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="recentBookingsTable">
                                                                    <!-- Dữ liệu sẽ được thêm vào qua JavaScript -->
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="styleSelector">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

<!-- Warning Section Ends -->
<!-- Required Jquery -->
<script type="text/javascript" src="assets/js/jquery/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="assets/js/popper.js/popper.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap/js/bootstrap.min.js"></script>
<!-- jquery slimscroll js -->
<script type="text/javascript" src="assets/js/jquery-slimscroll/jquery.slimscroll.js"></script>
<!-- modernizr js -->
<script type="text/javascript" src="assets/js/modernizr/modernizr.js"></script>
<!-- am chart -->
<script src="assets/pages/widget/amchart/amcharts.min.js"></script>
<script src="assets/pages/widget/amchart/serial.min.js"></script>
<!-- Todo js -->
<script type="text/javascript " src="assets/pages/todo/todo.js "></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Custom js -->
<script type="text/javascript" src="assets/pages/dashboard/custom-dashboard.js"></script>
<script type="text/javascript" src="assets/js/script.js"></script>
<script type="text/javascript " src="assets/js/SmoothScroll.js"></script>
<script src="assets/js/pcoded.min.js"></script>
<script src="assets/js/demo-12.js"></script>
<script src="assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
<script>
var $window = $(window);
var nav = $('.fixed-button');
    $window.scroll(function(){
        if ($window.scrollTop() >= 200) {
         nav.addClass('active');
     }
     else {
         nav.removeClass('active');
     }
 });
</script>
<script>
    // Kiểm tra xem người dùng đã đăng nhập chưa khi vào trang admin
    document.addEventListener('DOMContentLoaded', function () {
        const token = localStorage.getItem('accessToken');
        if (token) {
            const decodedToken = decodeToken(token);
            const role = decodedToken.role;

            if (role === 'Admin') {
                // Lấy thông tin admin từ API và cập nhật giao diện
                const email = decodedToken.email;
                getUserInfoByEmail(email);
                
                // Tải dữ liệu thống kê
                loadDashboardData();
                
                // Thêm sự kiện cho dropdown chọn khoảng thời gian
                document.getElementById('revenueChartPeriod').addEventListener('change', function() {
                    loadRevenueChartData(this.value);
                });
            } else {
                window.location.href = '../index.html'; // Chuyển hướng nếu không phải admin
            }
        } else {
            window.location.href = '../index.html'; // Chuyển hướng nếu chưa đăng nhập
        }
    });

    // Hàm giải mã JWT
    function decodeToken(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }

    // Hàm lấy thông tin người dùng từ email sau khi đăng nhập
    async function getUserInfoByEmail(email) {
        try {
            const encodedEmail = encodeURIComponent(email);
            const response = await fetch(`https://localhost:7290/api/Users/email/${encodedEmail}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const userData = await response.json();
                const userDropdown = document.getElementById('userDropdown');
                if (userDropdown) {
                    userDropdown.innerText = userData.fullName || 'Admin';
                }
                
                const userMenu = document.getElementById('user-menu');
                if (userMenu) {
                    userMenu.style.display = 'block';
                }
            } else {
                console.error('Không thể lấy thông tin người dùng');
            }
        } catch (error) {
            console.error('Lỗi:', error);
        }
    }
    
    // Hàm tải dữ liệu thống kê cho Dashboard
    async function loadDashboardData() {
        try {
            // Tải dữ liệu tổng quan
            await loadSummaryData();
            
            // Tải dữ liệu biểu đồ doanh thu mặc định (7 ngày)
            await loadRevenueChartData('week');
            
            // Tải dữ liệu biểu đồ phương thức thanh toán
            await loadPaymentMethodData();
            
            // Tải dữ liệu đặt sân gần đây
            await loadRecentBookings();
        } catch (error) {
            console.error('Lỗi tải dữ liệu Dashboard:', error);
        }
    }
    
    // Hàm tải dữ liệu tổng quan
    async function loadSummaryData() {
        try {
            // Lấy token từ localStorage
            const token = localStorage.getItem('accessToken');
            if (!token) {
                throw new Error('Chưa đăng nhập');
            }
            
            // Gọi API để lấy thống kê tổng quan
            const response = await fetch('https://localhost:7290/api/Statistics/summary', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu thống kê');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Lỗi lấy dữ liệu thống kê');
            }
            
            const stats = data.data;
            
            // Cập nhật thông tin lên giao diện
            // Tổng doanh thu
            document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue);
            updateChangeIndicator('revenue', stats.revenueChange);
            
            // Tổng lượt đặt sân
            document.getElementById('totalBookings').textContent = stats.totalBookings;
            updateChangeIndicator('bookings', stats.bookingsChange);
            
            // Tổng người dùng
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            updateChangeIndicator('users', stats.usersChange);
            
            // Doanh thu trung bình mỗi lượt đặt
            const averageRevenue = stats.totalBookings > 0 ? stats.totalRevenue / stats.totalBookings : 0;
            document.getElementById('averageRevenue').textContent = formatCurrency(averageRevenue);
            updateChangeIndicator('average', stats.averageRevenueChange);
            
        } catch (error) {
            console.error('Lỗi tải dữ liệu thống kê tổng quan:', error);
            // Hiển thị thông báo lỗi nếu cần
        }
    }
    
    // Hàm cập nhật chỉ số thay đổi (tăng/giảm)
    function updateChangeIndicator(elementPrefix, changePercent) {
        const textElement = document.getElementById(`${elementPrefix}ChangeText`);
        const iconElement = document.getElementById(`${elementPrefix}ChangeIcon`);
        
        if (changePercent > 0) {
            textElement.textContent = `Tăng ${changePercent.toFixed(1)}%`;
            iconElement.className = 'ti-arrow-up text-white f-16';
        } else if (changePercent < 0) {
            textElement.textContent = `Giảm ${Math.abs(changePercent).toFixed(1)}%`;
            iconElement.className = 'ti-arrow-down text-white f-16';
        } else {
            textElement.textContent = 'Không thay đổi';
            iconElement.className = 'ti-minus text-white f-16';
        }
    }
    
    // Biến lưu trữ đối tượng biểu đồ
    let revenueChart = null;
    let paymentMethodChart = null;
    
    // Hàm tải dữ liệu biểu đồ doanh thu
    async function loadRevenueChartData(period) {
        try {
            // Lấy token từ localStorage
            const token = localStorage.getItem('accessToken');
            if (!token) {
                throw new Error('Chưa đăng nhập');
            }
            
            // Gọi API để lấy dữ liệu doanh thu theo thời gian
            const response = await fetch(`https://localhost:7290/api/Statistics/revenue?period=${period}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu doanh thu');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Lỗi lấy dữ liệu doanh thu');
            }
            
            const chartData = data.data;
            
            // Vẽ biểu đồ
            renderRevenueChart(chartData.labels, chartData.data);
            
        } catch (error) {
            console.error('Lỗi tải dữ liệu biểu đồ doanh thu:', error);
            // Hiển thị thông báo lỗi nếu cần
        }
    }
    
    // Hàm vẽ biểu đồ doanh thu
    function renderRevenueChart(labels, data) {
        const canvas = document.getElementById('revenueChart');
        
        // Nếu biểu đồ đã tồn tại, hủy nó trước khi tạo biểu đồ mới
        if (revenueChart) {
            revenueChart.destroy();
        }
        
        // Tạo biểu đồ mới
        revenueChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += formatCurrency(context.raw);
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Hàm tải dữ liệu phương thức thanh toán
    async function loadPaymentMethodData() {
        try {
            // Lấy token từ localStorage
            const token = localStorage.getItem('accessToken');
            if (!token) {
                throw new Error('Chưa đăng nhập');
            }
            
            // Gọi API để lấy dữ liệu phương thức thanh toán
            const response = await fetch('https://localhost:7290/api/Statistics/payment-methods', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu phương thức thanh toán');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Lỗi lấy dữ liệu phương thức thanh toán');
            }
            
            const chartData = data.data;
            
            // Vẽ biểu đồ
            renderPaymentMethodChart(chartData.labels, chartData.data, chartData.colors);
            
        } catch (error) {
            console.error('Lỗi tải dữ liệu biểu đồ phương thức thanh toán:', error);
            // Hiển thị thông báo lỗi nếu cần
        }
    }
    
    // Hàm vẽ biểu đồ phương thức thanh toán
    function renderPaymentMethodChart(labels, data, colors) {
        const canvas = document.getElementById('paymentMethodChart');
        
        // Nếu biểu đồ đã tồn tại, hủy nó trước khi tạo biểu đồ mới
        if (paymentMethodChart) {
            paymentMethodChart.destroy();
        }
        
        // Tạo biểu đồ mới
        paymentMethodChart = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors || [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.formattedValue;
                                const percentage = Math.round((context.raw / context.dataset.data.reduce((a, b) => a + b, 0)) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Hàm tải dữ liệu đặt sân gần đây
    async function loadRecentBookings() {
        try {
            // Lấy token từ localStorage
            const token = localStorage.getItem('accessToken');
            if (!token) {
                throw new Error('Chưa đăng nhập');
            }
            
            // Gọi API để lấy dữ liệu đặt sân gần đây
            const response = await fetch('https://localhost:7290/api/Booking?pageNumber=1&pageSize=5', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu đặt sân gần đây');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Lỗi lấy dữ liệu đặt sân gần đây');
            }
            
            const bookings = data.items || [];
            
            // Hiển thị dữ liệu lên bảng
            renderRecentBookings(bookings);
            
        } catch (error) {
            console.error('Lỗi tải dữ liệu đặt sân gần đây:', error);
            // Hiển thị thông báo lỗi nếu cần
        }
    }
    
    // Hàm hiển thị đặt sân gần đây
    function renderRecentBookings(bookings) {
        const tableBody = document.getElementById('recentBookingsTable');
        
        // Xóa dữ liệu cũ
        tableBody.innerHTML = '';
        
        // Nếu không có dữ liệu
        if (bookings.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">Không có dữ liệu đặt sân</td>
                </tr>
            `;
            return;
        }
        
        // Hiển thị dữ liệu mới
        bookings.forEach(booking => {
            const row = document.createElement('tr');
            
            // Format ngày giờ
            const bookingDate = new Date(booking.bookingDate).toLocaleDateString('vi-VN');
            const startTime = booking.startTime ? booking.startTime.substring(0, 5) : '';
            const endTime = booking.endTime ? booking.endTime.substring(0, 5) : '';
            
            // Tạo class cho badge trạng thái
            let statusClass = '';
            switch(booking.status) {
                case 'Pending': statusClass = 'badge-warning'; break;
                case 'Confirmed': statusClass = 'badge-primary'; break;
                case 'Completed': statusClass = 'badge-success'; break;
                case 'Cancelled': statusClass = 'badge-danger'; break;
                default: statusClass = 'badge-secondary';
            }
            
            // Chuyển đổi status text
            let statusText = booking.status;
            switch(booking.status) {
                case 'Pending': statusText = 'Chờ xác nhận'; break;
                case 'Confirmed': statusText = 'Đã xác nhận'; break;
                case 'Completed': statusText = 'Hoàn thành'; break;
                case 'Cancelled': statusText = 'Đã hủy'; break;
            }
            
            row.innerHTML = `
                <td>${booking.bookingID}</td>
                <td>${booking.userName || 'N/A'}</td>
                <td>${booking.pitchName || 'N/A'}</td>
                <td>${bookingDate}</td>
                <td>${startTime} - ${endTime}</td>
                <td>${formatCurrency(booking.totalPrice)}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Hàm format tiền tệ VND
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }
    
    // Hàm đăng xuất
    function logout() {
        localStorage.removeItem('accessToken');
        window.location.href = '../index.html';
    }
</script>
<!-- Admin js -->
<script src="js/admin.js"></script>
</body>

</html>
